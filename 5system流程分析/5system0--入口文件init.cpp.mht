From: WizMime<support@wiz.cn>
Subject: =?gb2312?B?NXN5c3RlbTAtLcjrv9rOxLz+aW5pdC5jcHA=?=
Date: Date: Mon, 23 Oct 2017 08:44:03 +0800
MIME-Version: 1.0
Content-Type: multipart/related;
	type="multipart/alternative";
	boundary="----=_Next_Part_0415569279.840"

This is a multi-part message in MIME format.

------=_Next_Part_0415569279.840
Content-Type: multipart/alternative;
	boundary="----=_Next_Part_0138523093.966"


------=_Next_Part_0138523093.966
Content-Type: text/plain;
	charset="gb2312"
Content-Transfer-Encoding: quoted-printable

This is a multi-part message in MIME format.

------=_Next_Part_0138523093.966
Content-Type: text/html;
	charset="gb2312"
Content-Transfer-Encoding: quoted-printable

<!DOCTYPE HTML><html><head>=0D=0A<meta http-equiv=3D"Content-Type=
" content=3D"text/html; charset=3Dgb2312">=0A=0A<title>5system0--=
=C8=EB=BF=DA=CE=C4=BC=FEinit.cpp</title>=0A    <!--mark |wiz_cust=
om_css| for wizeditor replace it-->=0A<style id=3D"wiz_custom_css=
">html, body {            font-size: 15px;        }        body {=
            font-family: Helvetica, 'Hiragino Sans GB', '=CE=A2=C8=
=ED=D1=C5=BA=DA', 'Microsoft YaHei UI', SimSun, SimHei, arial, sa=
ns-serif;            line-height: 1.6;            margin: 0;    =20=
       padding: 20px 15px;            padding: 1.33rem 1rem;    =20=
   }        h1, h2, h3, h4, h5, h6 {            margin: 20px 0 10=
px;            margin: 1.33rem 0 0.667rem;            padding: 0;=
            font-weight: bold;        }        h1 {            fo=
nt-size: 21px;            font-size: 1.4rem;        }        h2 {=
            font-size: 20px;            font-size: 1.33rem;     =20=
  }        h3 {            font-size: 18px;            font-size:=
 1.2rem;        }        h4 {            font-size: 17px;       =20=
    font-size: 1.13rem;        }        h5 {            font-size=
: 15px;            font-size: 1rem;        }        h6 {        =20=
   font-size: 15px;            font-size: 1rem;            color:=
 #777777;            margin: 1rem 0;        }        div, p, ul,=20=
ol, dl, li {            margin: 0;        }        blockquote, ta=
ble, pre, code {            margin: 8px 0;        }        ul, ol=
 {            padding-left: 32px;            padding-left: 2.13re=
m;        }        blockquote {            padding: 0 12px;     =20=
      padding: 0 0.8rem;        }        blockquote > :first-chil=
d {            margin-top: 0;        }        blockquote > :last-=
child {            margin-bottom: 0;        }        img {      =20=
     border: 0;            max-width: 100%;            height: au=
to !important;            margin: 2px 0;        }        table {=20=
           border-collapse: collapse;            border: 1px soli=
d #bbbbbb;        }        td, th {            padding: 4px 8px;=20=
           border-collapse: collapse;            border: 1px soli=
d #bbbbbb;			        }        @media only screen and (-webkit-max=
-device-width: 1024px), only screen and (-o-max-device-width: 102=
4px), only screen and (max-device-width: 1024px), only screen and=
 (-webkit-min-device-pixel-ratio: 3), only screen and (-o-min-dev=
ice-pixel-ratio: 3), only screen and (min-device-pixel-ratio: 3)=20=
{            html, body {                font-size: 17px;       =20=
    }            body {                line-height: 1.7;        =20=
       padding: 0.75rem 0.9375rem;                color: #353c47;=
            }            h1 {                font-size: 2.125rem;=
            }            h2 {                font-size: 1.875rem;=
            }            h3 {                font-size: 1.625rem;=
            }            h4 {                font-size: 1.375rem;=
            }            h5 {                font-size: 1.125rem;=
            }            h6 {                color: inherit;    =20=
       }            ul, ol {                padding-left: 2.5rem;=
            }            blockquote {                padding: 0 0=
.9375rem;            }        }</style></head>=0A=0A<body spellch=
eck=3D"false" ><div><div><b><span data-wiz-span=3D"data-wiz-span"=
 style=3D"color: rgb(0, 0, 255); font-size: 0.867rem;">kernel=BD=D7=
=B6=CE=CD=A8=B9=FD=D6=B4=D0=D0try_to_run_init_process("/sbin/init=
")=A3=A8=BB=F2=D5=DF=C6=E4=CB=FB=D6=B8=B6=A8=C2=B7=BE=B6=CF=C2=B5=
=C4init=A3=A9</span><font color=3D"#ff0000"><span style=3D"font-s=
ize: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"dat=
a-wiz-span" style=3D"color: rgb(0, 0, 255); font-size: 0.867rem;"=
>=C0=B4=D6=B4=D0=D0init=BD=F8=B3=CC=A3=AC=D6=AE=BA=F3=BE=CD=BB=E1=
=BD=F8=C8=EBsystem/core/init/init.cpp=B5=C4main=BA=AF=CA=FD=A3=AC=
=D5=E6=D5=FD=B5=C4=BD=F8=C8=EB=D3=C3=BB=A7=BF=D5=BC=E4</span></sp=
an></font></b></div></div><div><font color=3D"#ff0000"><span styl=
e=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-=
span=3D"data-wiz-span" style=3D"color: rgb(255, 0, 0);"><br></spa=
n></span></font></div><div><font color=3D"#ff0000"><span data-wiz=
-span=3D"data-wiz-span"><span style=3D"font-size: 13.005px; line-=
height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(255, 0, 0);"><b>system/core/init=
/init.cpp</b></span></span><br></span></font></div><div><font col=
or=3D"#ff0000"><span data-wiz-span=3D"data-wiz-span"><div><span s=
tyle=3D"font-size: 13.005px; line-height: 20.808px;"><span data-w=
iz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rg=
b(0, 0, 0);">/*</span></span></div><div><span style=3D"font-size:=
 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wi=
z-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp=
;* Copyright (C) 2008 The Android Open Source Project</span></spa=
n></div><div><span style=3D"font-size: 13.005px; line-height: 20.=
808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=
 0.867rem; color: rgb(0, 0, 0);">&nbsp;*</span></span></div><div>=
<span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=
 data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; co=
lor: rgb(0, 0, 0);">&nbsp;* Licensed under the Apache License, Ve=
rsion 2.0 (the "License");</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp;* you may not use this file except in compliance with=
 the License.</span></span></div><div><span style=3D"font-size: 1=
3.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-=
span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;*=
 You may obtain a copy of the License at</span></span></div><div>=
<span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=
 data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; co=
lor: rgb(0, 0, 0);">&nbsp;*</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp;* &nbsp; &nbsp; &nbsp;http://www.apache.org/licenses/=
LICENSE-2.0</span></span></div><div><span style=3D"font-size: 13.=
005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-sp=
an" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;*</=
span></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"=
font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;* Unless require=
d by applicable law or agreed to in writing, software</span></spa=
n></div><div><span style=3D"font-size: 13.005px; line-height: 20.=
808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=
 0.867rem; color: rgb(0, 0, 0);">&nbsp;* distributed under the Li=
cense is distributed on an "AS IS" BASIS,</span></span></div><div=
><span style=3D"font-size: 13.005px; line-height: 20.808px;"><spa=
n data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; c=
olor: rgb(0, 0, 0);">&nbsp;* WITHOUT WARRANTIES OR CONDITIONS OF=20=
ANY KIND, either express or implied.</span></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">&nbsp;* See the License for the specific language=
 governing permissions and</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp;* limitations under the License.</span></span></div><=
div><span style=3D"font-size: 13.005px; line-height: 20.808px;"><=
span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem=
; color: rgb(0, 0, 0);">&nbsp;*/</span></span></div><div><span st=
yle=3D"font-size: 13.005px; line-height: 20.808px;"><br></span></=
div><div><span style=3D"font-size: 13.005px; line-height: 20.808p=
x;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.8=
67rem; color: rgb(0, 0, 0);">#include &lt;ctype.h&gt;</span></spa=
n></div><div><span style=3D"font-size: 13.005px; line-height: 20.=
808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=
 0.867rem; color: rgb(0, 0, 0);">#include &lt;dirent.h&gt;</span>=
</span></div><div><span style=3D"font-size: 13.005px; line-height=
: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-=
size: 0.867rem; color: rgb(0, 0, 0);">#include &lt;errno.h&gt;</s=
pan></span></div><div><span style=3D"font-size: 13.005px; line-he=
ight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"f=
ont-size: 0.867rem; color: rgb(0, 0, 0);">#include &lt;fcntl.h&gt=
;</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">#include &lt;fstream&=
gt;</span></span></div><div><span style=3D"font-size: 13.005px; l=
ine-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" styl=
e=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#include &lt;libg=
en.h&gt;</span></span></div><div><span style=3D"font-size: 13.005=
px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=
 style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#include &lt=
;paths.h&gt;</span></span></div><div><span style=3D"font-size: 13=
.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-s=
pan" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#include=
 &lt;signal.h&gt;</span></span></div><div><span style=3D"font-siz=
e: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-=
wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#in=
clude &lt;stdarg.h&gt;</span></span></div><div><span style=3D"fon=
t-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"=
data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);=
">#include &lt;stdio.h&gt;</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">#include &lt;stdlib.h&gt;</span></span></div><div><span sty=
le=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz=
-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(=
0, 0, 0);">#include &lt;string.h&gt;</span></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">#include &lt;sys/epoll.h&gt;</span></span></div><=
div><span style=3D"font-size: 13.005px; line-height: 20.808px;"><=
span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem=
; color: rgb(0, 0, 0);">#include &lt;sys/mount.h&gt;</span></span=
></div><div><span style=3D"font-size: 13.005px; line-height: 20.8=
08px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=20=
0.867rem; color: rgb(0, 0, 0);">#include &lt;sys/socket.h&gt;</sp=
an></span></div><div><span style=3D"font-size: 13.005px; line-hei=
ght: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fo=
nt-size: 0.867rem; color: rgb(0, 0, 0);">#include &lt;sys/stat.h&=
gt;</span></span></div><div><span style=3D"font-size: 13.005px; l=
ine-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" styl=
e=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#include &lt;sys/=
types.h&gt;</span></span></div><div><span style=3D"font-size: 13.=
005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-sp=
an" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#include=20=
&lt;sys/un.h&gt;</span></span></div><div><span style=3D"font-size=
: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-w=
iz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#inc=
lude &lt;sys/wait.h&gt;</span></span></div><div><span style=3D"fo=
nt-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">#include &lt;unistd.h&gt;</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><br></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><s=
pan data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=
 color: rgb(0, 0, 0);">#include &lt;mtd/mtd-user.h&gt;</span></sp=
an></div><div><span style=3D"font-size: 13.005px; line-height: 20=
.808px;"><br></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" s=
tyle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#include &lt;s=
elinux/selinux.h&gt;</span></span></div><div><span style=3D"font-=
size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"da=
ta-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">=
#include &lt;selinux/label.h&gt;</span></span></div><div><span st=
yle=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wi=
z-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb=
(0, 0, 0);">#include &lt;selinux/android.h&gt;</span></span></div=
><div><span style=3D"font-size: 13.005px; line-height: 20.808px;"=
><br></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"=
font-size: 0.867rem; color: rgb(0, 0, 0);">#include &lt;android-b=
ase/file.h&gt;</span></span></div><div><span style=3D"font-size:=20=
13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz=
-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#inclu=
de &lt;android-base/stringprintf.h&gt;</span></span></div><div><s=
pan style=3D"font-size: 13.005px; line-height: 20.808px;"><span d=
ata-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; colo=
r: rgb(0, 0, 0);">#include &lt;android-base/strings.h&gt;</span><=
/span></div><div><span style=3D"font-size: 13.005px; line-height:=
 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-s=
ize: 0.867rem; color: rgb(0, 0, 0);">#include &lt;cutils/android_=
reboot.h&gt;</span></span></div><div><span style=3D"font-size: 13=
.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-s=
pan" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#include=
 &lt;cutils/fs.h&gt;</span></span></div><div><span style=3D"font-=
size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"da=
ta-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">=
#include &lt;cutils/iosched_policy.h&gt;</span></span></div><div>=
<span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=
 data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; co=
lor: rgb(0, 0, 0);">#include &lt;cutils/list.h&gt;</span></span><=
/div><div><span style=3D"font-size: 13.005px; line-height: 20.808=
px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.=
867rem; color: rgb(0, 0, 0);">#include &lt;cutils/sockets.h&gt;</=
span></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"=
font-size: 0.867rem; color: rgb(0, 0, 0);">#include &lt;private/a=
ndroid_filesystem_config.h&gt;</span></span></div><div><span styl=
e=3D"font-size: 13.005px; line-height: 20.808px;"><br></span></di=
v><div><span style=3D"font-size: 13.005px; line-height: 20.808px;=
"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867=
rem; color: rgb(0, 0, 0);">#include &lt;memory&gt;</span></span><=
/div><div><span style=3D"font-size: 13.005px; line-height: 20.808=
px;"><br></span></div><div><span style=3D"font-size: 13.005px; li=
ne-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=
=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#include "action.h=
"</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">#include "bootchart.h=
"</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">#include "devices.h"<=
/span></span></div><div><span style=3D"font-size: 13.005px; line-=
height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">#include "import_pars=
er.h"</span></span></div><div><span style=3D"font-size: 13.005px;=
 line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" st=
yle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#include "init.=
h"</span></span></div><div><span style=3D"font-size: 13.005px; li=
ne-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=
=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#include "init_par=
ser.h"</span></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" s=
tyle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#include "keyc=
hords.h"</span></span></div><div><span style=3D"font-size: 13.005=
px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=
 style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#include "lo=
g.h"</span></span></div><div><span style=3D"font-size: 13.005px;=20=
line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" sty=
le=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#include "proper=
ty_service.h"</span></span></div><div><span style=3D"font-size: 1=
3.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-=
span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#includ=
e "service.h"</span></span></div><div><span style=3D"font-size: 1=
3.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-=
span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#includ=
e "signal_handler.h"</span></span></div><div><span style=3D"font-=
size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"da=
ta-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">=
#include "ueventd.h"</span></span></div><div><span style=3D"font-=
size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"da=
ta-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">=
#include "util.h"</span></span></div><div><span style=3D"font-siz=
e: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-=
wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#in=
clude "watchdogd.h"</span></span></div><div><span style=3D"font-s=
ize: 13.005px; line-height: 20.808px;"><br></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">struct selabel_handle *sehandle;</span></span></d=
iv><div><span style=3D"font-size: 13.005px; line-height: 20.808px=
;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.86=
7rem; color: rgb(0, 0, 0);">struct selabel_handle *sehandle_prop;=
</span></span></div><div><span style=3D"font-size: 13.005px; line=
-height: 20.808px;"><br></span></div><div><span style=3D"font-siz=
e: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-=
wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">sta=
tic int property_triggers_enabled =3D 0;</span></span></div><div>=
<span style=3D"font-size: 13.005px; line-height: 20.808px;"><br><=
/span></div><div><span style=3D"font-size: 13.005px; line-height:=
 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-s=
ize: 0.867rem; color: rgb(0, 0, 0);">static char qemu[32];</span>=
</span></div><div><span style=3D"font-size: 13.005px; line-height=
: 20.808px;"><br></span></div><div><span style=3D"font-size: 13.0=
05px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-spa=
n" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">int have_c=
onsole;</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=20=
style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">std::string c=
onsole_name =3D "/dev/console";</span></span></div><div><span sty=
le=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz=
-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(=
0, 0, 0);">static time_t process_needs_restart;</span></span></di=
v><div><span style=3D"font-size: 13.005px; line-height: 20.808px;=
"><br></span></div><div><span style=3D"font-size: 13.005px; line-=
height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">const char *ENV[32];<=
/span></span></div><div><span style=3D"font-size: 13.005px; line-=
height: 20.808px;"><br></span></div><div><span style=3D"font-size=
: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-w=
iz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">bool=
 waiting_for_exec =3D false;</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><br></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><s=
pan data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=
 color: rgb(0, 0, 0);">static int epoll_fd =3D -1;</span></span><=
/div><div><span style=3D"font-size: 13.005px; line-height: 20.808=
px;"><br></span></div><div><span style=3D"font-size: 13.005px; li=
ne-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=
=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">void register_epol=
l_handler(int fd, void (*fn)()) {</span></span></div><div><span s=
tyle=3D"font-size: 13.005px; line-height: 20.808px;"><span data-w=
iz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rg=
b(0, 0, 0);">&nbsp; &nbsp; epoll_event ev;</span></span></div><di=
v><span style=3D"font-size: 13.005px; line-height: 20.808px;"><sp=
an data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=20=
color: rgb(0, 0, 0);">&nbsp; &nbsp; ev.events =3D EPOLLIN;</span>=
</span></div><div><span style=3D"font-size: 13.005px; line-height=
: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-=
size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; ev.data.ptr =3D=
 reinterpret_cast&lt;void*&gt;(fn);</span></span></div><div><span=
 style=3D"font-size: 13.005px; line-height: 20.808px;"><span data=
-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=20=
rgb(0, 0, 0);">&nbsp; &nbsp; if (epoll_ctl(epoll_fd, EPOLL_CTL_AD=
D, fd, &amp;ev) =3D=3D -1) {</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; &nbsp; &nbsp; ERROR("epoll_ctl failed: %s\n",=
 strerror(errno));</span></span></div><div><span style=3D"font-si=
ze: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data=
-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&n=
bsp; &nbsp; }</span></span></div><div><span style=3D"font-size: 1=
3.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-=
span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">}</span=
></span></div><div><span style=3D"font-size: 13.005px; line-heigh=
t: 20.808px;"><br></span></div><div><span style=3D"font-size: 13.=
005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-sp=
an" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">/* add_en=
vironment - add "key=3Dvalue" to the current environment */</span=
></span></div><div><span style=3D"font-size: 13.005px; line-heigh=
t: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font=
-size: 0.867rem; color: rgb(0, 0, 0);">int add_environment(const=20=
char *key, const char *val)</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">{</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=20=
style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=
 size_t n;</span></span></div><div><span style=3D"font-size: 13.0=
05px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-spa=
n" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nb=
sp; size_t key_len =3D strlen(key);</span></span></div><div><span=
 style=3D"font-size: 13.005px; line-height: 20.808px;"><br></span=
></div><div><span style=3D"font-size: 13.005px; line-height: 20.8=
08px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=20=
0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; /* The last environ=
ment entry is reserved to terminate the list */</span></span></di=
v><div><span style=3D"font-size: 13.005px; line-height: 20.808px;=
"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867=
rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; for (n =3D 0; n &lt; (AR=
RAY_SIZE(ENV) - 1); n++) {</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><br></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><s=
pan data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=
 color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; /* Delete any=20=
existing entry for this key */</span></span></div><div><span styl=
e=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-=
span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0=
, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; if (ENV[n] !=3D NULL) {</sp=
an></span></div><div><span style=3D"font-size: 13.005px; line-hei=
ght: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fo=
nt-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nb=
sp; &nbsp; &nbsp; size_t entry_key_len =3D strcspn(ENV[n], "=3D")=
;</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp;=20=
&nbsp; &nbsp; &nbsp; if ((entry_key_len =3D=3D key_len) &amp;&amp=
; (strncmp(ENV[n], key, entry_key_len) =3D=3D 0)) {</span></span>=
</div><div><span style=3D"font-size: 13.005px; line-height: 20.80=
8px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0=
.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=
 &nbsp; &nbsp; &nbsp; free((char*)ENV[n]);</span></span></div><di=
v><span style=3D"font-size: 13.005px; line-height: 20.808px;"><sp=
an data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=20=
color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &=
nbsp; &nbsp; ENV[n] =3D NULL;</span></span></div><div><span style=
=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-s=
pan=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0,=
 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></span=
></div><div><span style=3D"font-size: 13.005px; line-height: 20.8=
08px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=20=
0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; }</sp=
an></span></div><div><span style=3D"font-size: 13.005px; line-hei=
ght: 20.808px;"><br></span></div><div><span style=3D"font-size: 1=
3.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-=
span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;=20=
&nbsp; &nbsp; &nbsp; /* Add entry if a free slot is available */<=
/span></span></div><div><span style=3D"font-size: 13.005px; line-=
height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp;=20=
&nbsp; if (ENV[n] =3D=3D NULL) {</span></span></div><div><span st=
yle=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wi=
z-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb=
(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char* entry=
;</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp;=20=
&nbsp; &nbsp; &nbsp; asprintf(&amp;entry, "%s=3D%s", key, val);</=
span></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"=
font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &=
nbsp; &nbsp; &nbsp; ENV[n] =3D entry;</span></span></div><div><sp=
an style=3D"font-size: 13.005px; line-height: 20.808px;"><span da=
ta-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color=
: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return=
 0;</span></span></div><div><span style=3D"font-size: 13.005px; l=
ine-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" styl=
e=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nb=
sp; &nbsp; }</span></span></div><div><span style=3D"font-size: 13=
.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-s=
pan" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &=
nbsp; }</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><br></span></div><div><span style=3D"f=
ont-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; ERROR("No env. room to store: '%s':'%s'\n", key,=
 val);</span></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><br></span></div><div><span style=3D"fo=
nt-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; return -1;</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">}</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><br></span></div><div><span style=3D"f=
ont-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">void property_changed(const char *name, const char *value)</sp=
an></span></div><div><span style=3D"font-size: 13.005px; line-hei=
ght: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fo=
nt-size: 0.867rem; color: rgb(0, 0, 0);">{</span></span></div><di=
v><span style=3D"font-size: 13.005px; line-height: 20.808px;"><sp=
an data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=20=
color: rgb(0, 0, 0);">&nbsp; &nbsp; if (property_triggers_enabled=
)</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp;=20=
&nbsp; ActionManager::GetInstance().QueuePropertyTrigger(name, va=
lue);</span></span></div><div><span style=3D"font-size: 13.005px;=
 line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" st=
yle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">}</span></span>=
</div><div><span style=3D"font-size: 13.005px; line-height: 20.80=
8px;"><br></span></div><div><span style=3D"font-size: 13.005px; l=
ine-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" styl=
e=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">static void resta=
rt_processes()</span></span></div><div><span style=3D"font-size:=20=
13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz=
-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">{</spa=
n></span></div><div><span style=3D"font-size: 13.005px; line-heig=
ht: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fon=
t-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; process_nee=
ds_restart =3D 0;</span></span></div><div><span style=3D"font-siz=
e: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-=
wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nb=
sp; &nbsp; ServiceManager::GetInstance().</span></span></div><div=
><span style=3D"font-size: 13.005px; line-height: 20.808px;"><spa=
n data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; c=
olor: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; ForEachServiceWi=
thFlags(SVC_RESTARTING, [] (Service* s) {</span></span></div><div=
><span style=3D"font-size: 13.005px; line-height: 20.808px;"><spa=
n data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; c=
olor: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &n=
bsp; &nbsp; s-&gt;RestartIfNeeded(process_needs_restart);</span><=
/span></div><div><span style=3D"font-size: 13.005px; line-height:=
 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-s=
ize: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp;=20=
&nbsp; &nbsp; });</span></span></div><div><span style=3D"font-siz=
e: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-=
wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">}</=
span></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><br></span></div><div><span style=3D"font-size:=
 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wi=
z-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">void=20=
handle_control_message(const std::string&amp; msg, const std::str=
ing&amp; name) {</span></span></div><div><span style=3D"font-size=
: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-w=
iz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbs=
p; &nbsp; Service* svc =3D ServiceManager::GetInstance().FindServ=
iceByName(name);</span></span></div><div><span style=3D"font-size=
: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-w=
iz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbs=
p; &nbsp; if (svc =3D=3D nullptr) {</span></span></div><div><span=
 style=3D"font-size: 13.005px; line-height: 20.808px;"><span data=
-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=20=
rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; ERROR("no such service=
 '%s'\n", name.c_str());</span></span></div><div><span style=3D"f=
ont-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; return;</span></span></div><div><s=
pan style=3D"font-size: 13.005px; line-height: 20.808px;"><span d=
ata-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; colo=
r: rgb(0, 0, 0);">&nbsp; &nbsp; }</span></span></div><div><span s=
tyle=3D"font-size: 13.005px; line-height: 20.808px;"><br></span><=
/div><div><span style=3D"font-size: 13.005px; line-height: 20.808=
px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.=
867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (msg =3D=3D "start=
") {</span></span></div><div><span style=3D"font-size: 13.005px;=20=
line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" sty=
le=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &n=
bsp; &nbsp; svc-&gt;Start();</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; } else if (msg =3D=3D "stop") {</span></span>=
</div><div><span style=3D"font-size: 13.005px; line-height: 20.80=
8px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0=
.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; svc-&g=
t;Stop();</span></span></div><div><span style=3D"font-size: 13.00=
5px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span=
" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbs=
p; } else if (msg =3D=3D "restart") {</span></span></div><div><sp=
an style=3D"font-size: 13.005px; line-height: 20.808px;"><span da=
ta-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color=
: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; svc-&gt;Restart();</=
span></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"=
font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; } else {=
</span></span></div><div><span style=3D"font-size: 13.005px; line=
-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp;=20=
&nbsp; ERROR("unknown control msg '%s'\n", msg.c_str());</span></=
span></div><div><span style=3D"font-size: 13.005px; line-height:=20=
20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-si=
ze: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span></span>=
</div><div><span style=3D"font-size: 13.005px; line-height: 20.80=
8px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0=
.867rem; color: rgb(0, 0, 0);">}</span></span></div><div><span st=
yle=3D"font-size: 13.005px; line-height: 20.808px;"><br></span></=
div><div><span style=3D"font-size: 13.005px; line-height: 20.808p=
x;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.8=
67rem; color: rgb(0, 0, 0);">static int wait_for_coldboot_done_ac=
tion(const std::vector&lt;std::string&gt;&amp; args) {</span></sp=
an></div><div><span style=3D"font-size: 13.005px; line-height: 20=
.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size=
: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; Timer t;</span></=
span></div><div><span style=3D"font-size: 13.005px; line-height:=20=
20.808px;"><br></span></div><div><span style=3D"font-size: 13.005=
px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=
 style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp=
; NOTICE("Waiting for %s...\n", COLDBOOT_DONE);</span></span></di=
v><div><span style=3D"font-size: 13.005px; line-height: 20.808px;=
"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867=
rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; // Any longer than 1s is=
 an unreasonable length of time to delay booting.</span></span></=
div><div><span style=3D"font-size: 13.005px; line-height: 20.808p=
x;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.8=
67rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; // If you're hitting t=
his timeout, check that you didn't make your</span></span></div><=
div><span style=3D"font-size: 13.005px; line-height: 20.808px;"><=
span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem=
; color: rgb(0, 0, 0);">&nbsp; &nbsp; // sepolicy regular express=
ions too expensive (http://b/19899875).</span></span></div><div><=
span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=20=
data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; col=
or: rgb(0, 0, 0);">&nbsp; &nbsp; if (wait_for_file(COLDBOOT_DONE,=
 1)) {</span></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" s=
tyle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=20=
&nbsp; &nbsp; ERROR("Timed out waiting for %s\n", COLDBOOT_DONE);=
</span></span></div><div><span style=3D"font-size: 13.005px; line=
-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span=
></span></div><div><span style=3D"font-size: 13.005px; line-heigh=
t: 20.808px;"><br></span></div><div><span style=3D"font-size: 13.=
005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-sp=
an" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &n=
bsp; NOTICE("Waiting for %s took %.2fs.\n", COLDBOOT_DONE, t.dura=
tion());</span></span></div><div><span style=3D"font-size: 13.005=
px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=
 style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp=
; return 0;</span></span></div><div><span style=3D"font-size: 13.=
005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-sp=
an" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">}</span><=
/span></div><div><span style=3D"font-size: 13.005px; line-height:=
 20.808px;"><br></span></div><div><span style=3D"font-size: 13.00=
5px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span=
" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">/*</span></=
span></div><div><span style=3D"font-size: 13.005px; line-height:=20=
20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-si=
ze: 0.867rem; color: rgb(0, 0, 0);">&nbsp;* Writes 512 bytes of o=
utput from Hardware RNG (/dev/hw_random, backed</span></span></di=
v><div><span style=3D"font-size: 13.005px; line-height: 20.808px;=
"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867=
rem; color: rgb(0, 0, 0);">&nbsp;* by Linux kernel's hw_random fr=
amework) into Linux RNG's via /dev/urandom.</span></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><s=
pan data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=
 color: rgb(0, 0, 0);">&nbsp;* Does nothing if Hardware RNG is no=
t present.</span></span></div><div><span style=3D"font-size: 13.0=
05px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-spa=
n" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;*</s=
pan></span></div><div><span style=3D"font-size: 13.005px; line-he=
ight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"f=
ont-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;* Since we don't=20=
yet trust the quality of Hardware RNG, these bytes are not</span>=
</span></div><div><span style=3D"font-size: 13.005px; line-height=
: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-=
size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;* mixed into the prim=
ary pool of Linux RNG and the entropy estimate is left</span></sp=
an></div><div><span style=3D"font-size: 13.005px; line-height: 20=
.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size=
: 0.867rem; color: rgb(0, 0, 0);">&nbsp;* unmodified.</span></spa=
n></div><div><span style=3D"font-size: 13.005px; line-height: 20.=
808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=
 0.867rem; color: rgb(0, 0, 0);">&nbsp;*</span></span></div><div>=
<span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=
 data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; co=
lor: rgb(0, 0, 0);">&nbsp;* If the HW RNG device /dev/hw_random i=
s present, we require that at least</span></span></div><div><span=
 style=3D"font-size: 13.005px; line-height: 20.808px;"><span data=
-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=20=
rgb(0, 0, 0);">&nbsp;* 512 bytes read from it are written into Li=
nux RNG. QA is expected to catch</span></span></div><div><span st=
yle=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wi=
z-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb=
(0, 0, 0);">&nbsp;* devices/configurations where these I/O operat=
ions are blocking for a long</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp;* time. We do not reboot or halt on failures, as this=
 is a best-effort</span></span></div><div><span style=3D"font-siz=
e: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-=
wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nb=
sp;* attempt.</span></span></div><div><span style=3D"font-size: 1=
3.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-=
span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;*=
/</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">static int mix_hwrng_=
into_linux_rng_action(const std::vector&lt;std::string&gt;&amp; a=
rgs)</span></span></div><div><span style=3D"font-size: 13.005px;=20=
line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" sty=
le=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">{</span></span><=
/div><div><span style=3D"font-size: 13.005px; line-height: 20.808=
px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.=
867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; int result =3D -1;</s=
pan></span></div><div><span style=3D"font-size: 13.005px; line-he=
ight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"f=
ont-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; int hwran=
dom_fd =3D -1;</span></span></div><div><span style=3D"font-size:=20=
13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz=
-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;=
 &nbsp; int urandom_fd =3D -1;</span></span></div><div><span styl=
e=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-=
span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0=
, 0, 0);">&nbsp; &nbsp; char buf[512];</span></span></div><div><s=
pan style=3D"font-size: 13.005px; line-height: 20.808px;"><span d=
ata-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; colo=
r: rgb(0, 0, 0);">&nbsp; &nbsp; ssize_t chunk_size;</span></span>=
</div><div><span style=3D"font-size: 13.005px; line-height: 20.80=
8px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0=
.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; size_t total_bytes_w=
ritten =3D 0;</span></span></div><div><span style=3D"font-size: 1=
3.005px; line-height: 20.808px;"><br></span></div><div><span styl=
e=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-=
span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0=
, 0, 0);">&nbsp; &nbsp; hwrandom_fd =3D TEMP_FAILURE_RETRY(</span=
></span></div><div><span style=3D"font-size: 13.005px; line-heigh=
t: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font=
-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp=
; &nbsp; &nbsp; open("/dev/hw_random", O_RDONLY | O_NOFOLLOW | O_=
CLOEXEC));</span></span></div><div><span style=3D"font-size: 13.0=
05px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-spa=
n" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nb=
sp; if (hwrandom_fd =3D=3D -1) {</span></span></div><div><span st=
yle=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wi=
z-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb=
(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; if (errno =3D=3D ENOENT)=20=
{</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp;=20=
&nbsp; &nbsp; ERROR("/dev/hw_random not found\n");</span></span><=
/div><div><span style=3D"font-size: 13.005px; line-height: 20.808=
px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.=
867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=20=
/* It's not an error to not have a Hardware RNG. */</span></span>=
</div><div><span style=3D"font-size: 13.005px; line-height: 20.80=
8px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0=
.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=
 result =3D 0;</span></span></div><div><span style=3D"font-size:=20=
13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz=
-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;=
 &nbsp; &nbsp; &nbsp; } else {</span></span></div><div><span styl=
e=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-=
span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0=
, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ERROR("Failed to ope=
n /dev/hw_random: %s\n", strerror(errno));</span></span></div><di=
v><span style=3D"font-size: 13.005px; line-height: 20.808px;"><sp=
an data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=20=
color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; }</span></span>=
</div><div><span style=3D"font-size: 13.005px; line-height: 20.80=
8px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0=
.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; goto r=
et;</span></span></div><div><span style=3D"font-size: 13.005px; l=
ine-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" styl=
e=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</=
span></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><br></span></div><div><span style=3D"font-size:=
 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wi=
z-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp=
; &nbsp; urandom_fd =3D TEMP_FAILURE_RETRY(</span></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><s=
pan data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=
 color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=20=
open("/dev/urandom", O_WRONLY | O_NOFOLLOW | O_CLOEXEC));</span><=
/span></div><div><span style=3D"font-size: 13.005px; line-height:=
 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-s=
ize: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (urandom_fd=
 =3D=3D -1) {</span></span></div><div><span style=3D"font-size: 1=
3.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-=
span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;=20=
&nbsp; &nbsp; &nbsp; ERROR("Failed to open /dev/urandom: %s\n", s=
trerror(errno));</span></span></div><div><span style=3D"font-size=
: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-w=
iz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbs=
p; &nbsp; &nbsp; &nbsp; goto ret;</span></span></div><div><span s=
tyle=3D"font-size: 13.005px; line-height: 20.808px;"><span data-w=
iz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rg=
b(0, 0, 0);">&nbsp; &nbsp; }</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><br></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><s=
pan data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=
 color: rgb(0, 0, 0);">&nbsp; &nbsp; while (total_bytes_written &=
lt; sizeof(buf)) {</span></span></div><div><span style=3D"font-si=
ze: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data=
-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&n=
bsp; &nbsp; &nbsp; &nbsp; chunk_size =3D TEMP_FAILURE_RETRY(</spa=
n></span></div><div><span style=3D"font-size: 13.005px; line-heig=
ht: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fon=
t-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbs=
p; &nbsp; &nbsp; &nbsp; &nbsp; read(hwrandom_fd, buf, sizeof(buf)=
 - total_bytes_written));</span></span></div><div><span style=3D"=
font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; if (chunk_size =3D=3D -1) {</span>=
</span></div><div><span style=3D"font-size: 13.005px; line-height=
: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-=
size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp;=
 &nbsp; &nbsp; ERROR("Failed to read from /dev/hw_random: %s\n",=20=
strerror(errno));</span></span></div><div><span style=3D"font-siz=
e: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-=
wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nb=
sp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto ret;</span></span></d=
iv><div><span style=3D"font-size: 13.005px; line-height: 20.808px=
;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.86=
7rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; } else if=
 (chunk_size =3D=3D 0) {</span></span></div><div><span style=3D"f=
ont-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ERROR("Failed to rea=
d from /dev/hw_random: EOF\n");</span></span></div><div><span sty=
le=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz=
-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(=
0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto ret;</s=
pan></span></div><div><span style=3D"font-size: 13.005px; line-he=
ight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"f=
ont-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &n=
bsp; }</span></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><br></span></div><div><span style=3D"fo=
nt-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; chunk_size =3D TEMP_FAILURE_RETRY(=
write(urandom_fd, buf, chunk_size));</span></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; if (chunk_size =3D=3D=
 -1) {</span></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" s=
tyle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=20=
&nbsp; &nbsp; &nbsp; &nbsp; ERROR("Failed to write to /dev/urando=
m: %s\n", strerror(errno));</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto ret;</span><=
/span></div><div><span style=3D"font-size: 13.005px; line-height:=
 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-s=
ize: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp;=20=
}</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp;=20=
&nbsp; total_bytes_written +=3D chunk_size;</span></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><s=
pan data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=
 color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span></span></div><div><s=
pan style=3D"font-size: 13.005px; line-height: 20.808px;"><br></s=
pan></div><div><span style=3D"font-size: 13.005px; line-height: 2=
0.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-siz=
e: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; INFO("Mixed %zu=20=
bytes from /dev/hw_random into /dev/urandom",</span></span></div>=
<div><span style=3D"font-size: 13.005px; line-height: 20.808px;">=
<span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867re=
m; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp=
; &nbsp; &nbsp; total_bytes_written);</span></span></div><div><sp=
an style=3D"font-size: 13.005px; line-height: 20.808px;"><span da=
ta-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color=
: rgb(0, 0, 0);">&nbsp; &nbsp; result =3D 0;</span></span></div><=
div><span style=3D"font-size: 13.005px; line-height: 20.808px;"><=
br></span></div><div><span style=3D"font-size: 13.005px; line-hei=
ght: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fo=
nt-size: 0.867rem; color: rgb(0, 0, 0);">ret:</span></span></div>=
<div><span style=3D"font-size: 13.005px; line-height: 20.808px;">=
<span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867re=
m; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (hwrandom_fd !=3D -1) {=
</span></span></div><div><span style=3D"font-size: 13.005px; line=
-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp;=20=
&nbsp; close(hwrandom_fd);</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; }</span></span></div><div><span style=3D"font=
-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"d=
ata-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);"=
>&nbsp; &nbsp; if (urandom_fd !=3D -1) {</span></span></div><div>=
<span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=
 data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; co=
lor: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; close(urandom_fd)=
;</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span=
></span></div><div><span style=3D"font-size: 13.005px; line-heigh=
t: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font=
-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; return resul=
t;</span></span></div><div><span style=3D"font-size: 13.005px; li=
ne-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=
=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">}</span></span></d=
iv><div><span style=3D"font-size: 13.005px; line-height: 20.808px=
;"><br></span></div><div><span style=3D"font-size: 13.005px; line=
-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">static void security_=
failure() {</span></span></div><div><span style=3D"font-size: 13.=
005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-sp=
an" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &n=
bsp; ERROR("Security failure; rebooting into recovery mode...\n")=
;</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; android=
_reboot(ANDROID_RB_RESTART2, 0, "recovery");</span></span></div><=
div><span style=3D"font-size: 13.005px; line-height: 20.808px;"><=
span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem=
; color: rgb(0, 0, 0);">&nbsp; &nbsp; while (true) { pause(); } &=
nbsp;// never reached</span></span></div><div><span style=3D"font=
-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"d=
ata-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);"=
>}</span></span></div><div><span style=3D"font-size: 13.005px; li=
ne-height: 20.808px;"><br></span></div><div><span style=3D"font-s=
ize: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"dat=
a-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#=
define MMAP_RND_PATH "/proc/sys/vm/mmap_rnd_bits"</span></span></=
div><div><span style=3D"font-size: 13.005px; line-height: 20.808p=
x;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.8=
67rem; color: rgb(0, 0, 0);">#define MMAP_RND_COMPAT_PATH "/proc/=
sys/vm/mmap_rnd_compat_bits"</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><br></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><s=
pan data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=
 color: rgb(0, 0, 0);">/* __attribute__((unused)) due to lack of=20=
mips support: see mips block</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp;* in set_mmap_rnd_bits_action */</span></span></div><=
div><span style=3D"font-size: 13.005px; line-height: 20.808px;"><=
span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem=
; color: rgb(0, 0, 0);">static bool __attribute__((unused)) set_m=
map_rnd_bits_min(int start, int min, bool compat) {</span></span>=
</div><div><span style=3D"font-size: 13.005px; line-height: 20.80=
8px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0=
.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; std::string path;</s=
pan></span></div><div><span style=3D"font-size: 13.005px; line-he=
ight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"f=
ont-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (compa=
t) {</span></span></div><div><span style=3D"font-size: 13.005px;=20=
line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" sty=
le=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &n=
bsp; &nbsp; path =3D MMAP_RND_COMPAT_PATH;</span></span></div><di=
v><span style=3D"font-size: 13.005px; line-height: 20.808px;"><sp=
an data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=20=
color: rgb(0, 0, 0);">&nbsp; &nbsp; } else {</span></span></div><=
div><span style=3D"font-size: 13.005px; line-height: 20.808px;"><=
span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem=
; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; path =3D MMAP=
_RND_PATH;</span></span></div><div><span style=3D"font-size: 13.0=
05px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-spa=
n" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nb=
sp; }</span></span></div><div><span style=3D"font-size: 13.005px;=
 line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" st=
yle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; s=
td::ifstream inf(path, std::fstream::in);</span></span></div><div=
><span style=3D"font-size: 13.005px; line-height: 20.808px;"><spa=
n data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; c=
olor: rgb(0, 0, 0);">&nbsp; &nbsp; if (!inf) {</span></span></div=
><div><span style=3D"font-size: 13.005px; line-height: 20.808px;"=
><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867r=
em; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; return fals=
e;</span></span></div><div><span style=3D"font-size: 13.005px; li=
ne-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=
=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</s=
pan></span></div><div><span style=3D"font-size: 13.005px; line-he=
ight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"f=
ont-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; while (st=
art &gt;=3D min) {</span></span></div><div><span style=3D"font-si=
ze: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data=
-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&n=
bsp; &nbsp; &nbsp; &nbsp; // try to write out new value</span></s=
pan></div><div><span style=3D"font-size: 13.005px; line-height: 2=
0.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-siz=
e: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; st=
d::string str_val =3D std::to_string(start);</span></span></div><=
div><span style=3D"font-size: 13.005px; line-height: 20.808px;"><=
span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem=
; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; std::ofstream=
 of(path, std::fstream::out);</span></span></div><div><span style=
=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-s=
pan=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0,=
 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; if (!of) {</span></span></di=
v><div><span style=3D"font-size: 13.005px; line-height: 20.808px;=
"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867=
rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nb=
sp; return false;</span></span></div><div><span style=3D"font-siz=
e: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-=
wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nb=
sp; &nbsp; &nbsp; &nbsp; }</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; &nbsp; &nbsp; of &lt;&lt; str_val &lt;&lt; st=
d::endl;</span></span></div><div><span style=3D"font-size: 13.005=
px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=
 style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp=
; &nbsp; &nbsp; of.close();</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><br></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><s=
pan data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=
 color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; // check to ma=
ke sure it was recorded</span></span></div><div><span style=3D"fo=
nt-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; inf.seekg(0);</span></span></div><=
div><span style=3D"font-size: 13.005px; line-height: 20.808px;"><=
span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem=
; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; std::string s=
tr_rec;</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=20=
style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=
 &nbsp; &nbsp; inf &gt;&gt; str_rec;</span></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; if (str_val.compare(s=
tr_rec) =3D=3D 0) {</span></span></div><div><span style=3D"font-s=
ize: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"dat=
a-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&=
nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</span></span></di=
v><div><span style=3D"font-size: 13.005px; line-height: 20.808px;=
"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867=
rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; }</span></=
span></div><div><span style=3D"font-size: 13.005px; line-height:=20=
20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-si=
ze: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; s=
tart--;</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=20=
style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=
 }</span></span></div><div><span style=3D"font-size: 13.005px; li=
ne-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=
=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; inf.=
close();</span></span></div><div><span style=3D"font-size: 13.005=
px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=
 style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp=
; return (start &gt;=3D min);</span></span></div><div><span style=
=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-s=
pan=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0,=
 0, 0);">}</span></span></div><div><span style=3D"font-size: 13.0=
05px; line-height: 20.808px;"><br></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">/*</span></span></div><div><span style=3D"font-size: 13.005=
px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=
 style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;* Set=20=
/proc/sys/vm/mmap_rnd_bits and potentially</span></span></div><di=
v><span style=3D"font-size: 13.005px; line-height: 20.808px;"><sp=
an data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=20=
color: rgb(0, 0, 0);">&nbsp;* /proc/sys/vm/mmap_rnd_compat_bits t=
o the maximum supported values.</span></span></div><div><span sty=
le=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz=
-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(=
0, 0, 0);">&nbsp;* Returns -1 if unable to set these to an accept=
able value. &nbsp;Apply</span></span></div><div><span style=3D"fo=
nt-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp;* upstream patch-sets https://lkml.org/lkml/2015/12/21/3=
37 and</span></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" s=
tyle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;* https:=
//lkml.org/lkml/2016/2/4/831 to enable this.</span></span></div><=
div><span style=3D"font-size: 13.005px; line-height: 20.808px;"><=
span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem=
; color: rgb(0, 0, 0);">&nbsp;*/</span></span></div><div><span st=
yle=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wi=
z-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb=
(0, 0, 0);">static int set_mmap_rnd_bits_action(const std::vector=
&lt;std::string&gt;&amp; args)</span></span></div><div><span styl=
e=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-=
span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0=
, 0, 0);">{</span></span></div><div><span style=3D"font-size: 13.=
005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-sp=
an" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &n=
bsp; int ret =3D -1;</span></span></div><div><span style=3D"font-=
size: 13.005px; line-height: 20.808px;"><br></span></div><div><sp=
an style=3D"font-size: 13.005px; line-height: 20.808px;"><span da=
ta-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color=
: rgb(0, 0, 0);">&nbsp; &nbsp; /* values are arch-dependent */</s=
pan></span></div><div><span style=3D"font-size: 13.005px; line-he=
ight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"f=
ont-size: 0.867rem; color: rgb(0, 0, 0);">#if defined(__aarch64__=
)</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; /* arm6=
4 supports 18 - 33 bits depending on pagesize and VA_SIZE */</spa=
n></span></div><div><span style=3D"font-size: 13.005px; line-heig=
ht: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fon=
t-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (set_mma=
p_rnd_bits_min(33, 24, false)</span></span></div><div><span style=
=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-s=
pan=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0,=
 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; set=
_mmap_rnd_bits_min(16, 16, true)) {</span></span></div><div><span=
 style=3D"font-size: 13.005px; line-height: 20.808px;"><span data=
-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=20=
rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; ret =3D 0;</span></spa=
n></div><div><span style=3D"font-size: 13.005px; line-height: 20.=
808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=
 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span></span></d=
iv><div><span style=3D"font-size: 13.005px; line-height: 20.808px=
;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.86=
7rem; color: rgb(0, 0, 0);">#elif defined(__x86_64__)</span></spa=
n></div><div><span style=3D"font-size: 13.005px; line-height: 20.=
808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=
 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; /* x86_64 supports=
 28 - 32 bits */</span></span></div><div><span style=3D"font-size=
: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-w=
iz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbs=
p; &nbsp; if (set_mmap_rnd_bits_min(32, 32, false)</span></span><=
/div><div><span style=3D"font-size: 13.005px; line-height: 20.808=
px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.=
867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=20=
&nbsp; &amp;&amp; set_mmap_rnd_bits_min(16, 16, true)) {</span></=
span></div><div><span style=3D"font-size: 13.005px; line-height:=20=
20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-si=
ze: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; r=
et =3D 0;</span></span></div><div><span style=3D"font-size: 13.00=
5px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span=
" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbs=
p; }</span></span></div><div><span style=3D"font-size: 13.005px;=20=
line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" sty=
le=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#elif defined(__=
arm__) || defined(__i386__)</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; /* check to see if we're running on 64-bit ke=
rnel */</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=20=
style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=
 bool h64 =3D !access(MMAP_RND_COMPAT_PATH, F_OK);</span></span><=
/div><div><span style=3D"font-size: 13.005px; line-height: 20.808=
px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.=
867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; /* supported 32-bit a=
rchitecture must have 16 bits set */</span></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">&nbsp; &nbsp; if (set_mmap_rnd_bits_min(16, 16, h=
64)) {</span></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" s=
tyle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=20=
&nbsp; &nbsp; ret =3D 0;</span></span></div><div><span style=3D"f=
ont-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; }</span></span></div><div><span style=3D"font-si=
ze: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data=
-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#e=
lif defined(__mips__) || defined(__mips64__)</span></span></div><=
div><span style=3D"font-size: 13.005px; line-height: 20.808px;"><=
span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem=
; color: rgb(0, 0, 0);">&nbsp; &nbsp; // TODO: add mips support b=
/27788820</span></span></div><div><span style=3D"font-size: 13.00=
5px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span=
" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbs=
p; ret =3D 0;</span></span></div><div><span style=3D"font-size: 1=
3.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-=
span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">#else</=
span></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"=
font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; ERROR("U=
nknown architecture\n");</span></span></div><div><span style=3D"f=
ont-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">#endif</span></span></div><div><span style=3D"font-size: 13.00=
5px; line-height: 20.808px;"><br></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">#ifdef __BRILLO__</span></span></div><div><span style=3D"fo=
nt-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; // TODO: b/27794137</span></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">&nbsp; &nbsp; ret =3D 0;</span></span></div><div>=
<span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=
 data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; co=
lor: rgb(0, 0, 0);">#endif</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; if (ret =3D=3D -1) {</span></span></div><div>=
<span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=
 data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; co=
lor: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; ERROR("Unable to=20=
set adequate mmap entropy value!\n");</span></span></div><div><sp=
an style=3D"font-size: 13.005px; line-height: 20.808px;"><span da=
ta-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color=
: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; security_failure();<=
/span></span></div><div><span style=3D"font-size: 13.005px; line-=
height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span=
></span></div><div><span style=3D"font-size: 13.005px; line-heigh=
t: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font=
-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; return ret;<=
/span></span></div><div><span style=3D"font-size: 13.005px; line-=
height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">}</span></span></div>=
<div><span style=3D"font-size: 13.005px; line-height: 20.808px;">=
<br></span></div><div><span style=3D"font-size: 13.005px; line-he=
ight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"f=
ont-size: 0.867rem; color: rgb(0, 0, 0);">static int keychord_ini=
t_action(const std::vector&lt;std::string&gt;&amp; args)</span></=
span></div><div><span style=3D"font-size: 13.005px; line-height:=20=
20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-si=
ze: 0.867rem; color: rgb(0, 0, 0);">{</span></span></div><div><sp=
an style=3D"font-size: 13.005px; line-height: 20.808px;"><span da=
ta-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color=
: rgb(0, 0, 0);">&nbsp; &nbsp; keychord_init();</span></span></di=
v><div><span style=3D"font-size: 13.005px; line-height: 20.808px;=
"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867=
rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; return 0;</span></span><=
/div><div><span style=3D"font-size: 13.005px; line-height: 20.808=
px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.=
867rem; color: rgb(0, 0, 0);">}</span></span></div><div><span sty=
le=3D"font-size: 13.005px; line-height: 20.808px;"><br></span></d=
iv><div><span style=3D"font-size: 13.005px; line-height: 20.808px=
;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.86=
7rem; color: rgb(0, 0, 0);">static int console_init_action(const=20=
std::vector&lt;std::string&gt;&amp; args)</span></span></div><div=
><span style=3D"font-size: 13.005px; line-height: 20.808px;"><spa=
n data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; c=
olor: rgb(0, 0, 0);">{</span></span></div><div><span style=3D"fon=
t-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"=
data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);=
">&nbsp; &nbsp; std::string console =3D property_get("ro.boot.con=
sole");</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=20=
style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=
 if (!console.empty()) {</span></span></div><div><span style=3D"f=
ont-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; console_name =3D "/dev/" + console=
;</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span=
></span></div><div><span style=3D"font-size: 13.005px; line-heigh=
t: 20.808px;"><br></span></div><div><span style=3D"font-size: 13.=
005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-sp=
an" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &n=
bsp; int fd =3D open(console_name.c_str(), O_RDWR | O_CLOEXEC);</=
span></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"=
font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (fd &=
gt;=3D 0)</span></span></div><div><span style=3D"font-size: 13.00=
5px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span=
" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbs=
p; &nbsp; &nbsp; have_console =3D 1;</span></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">#ifdef MTK_INIT</span></span></div><div><span sty=
le=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz=
-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(=
0, 0, 0);">&nbsp; &nbsp; else</span></span></div><div><span style=
=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-s=
pan=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0,=
 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; ERROR("console_init: can't o=
pen %s\n", console_name.c_str());</span></span></div><div><span s=
tyle=3D"font-size: 13.005px; line-height: 20.808px;"><span data-w=
iz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rg=
b(0, 0, 0);">#endif</span></span></div><div><span style=3D"font-s=
ize: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"dat=
a-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&=
nbsp; &nbsp; close(fd);</span></span></div><div><span style=3D"fo=
nt-size: 13.005px; line-height: 20.808px;"><br></span></div><div>=
<span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=
 data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; co=
lor: rgb(0, 0, 0);">&nbsp; &nbsp; fd =3D open("/dev/tty0", O_WRON=
LY | O_CLOEXEC);</span></span></div><div><span style=3D"font-size=
: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-w=
iz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbs=
p; &nbsp; if (fd &gt;=3D 0) {</span></span></div><div><span style=
=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-s=
pan=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0,=
 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; const char *msg;</span></spa=
n></div><div><span style=3D"font-size: 13.005px; line-height: 20.=
808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=
 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbs=
p; &nbsp; msg =3D "\n"</span></span></div><div><span style=3D"fon=
t-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"=
data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);=
">&nbsp; &nbsp; &nbsp; &nbsp; "\n"</span></span></div><div><span=20=
style=3D"font-size: 13.005px; line-height: 20.808px;"><span data-=
wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: r=
gb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; "\n"</span></span></div=
><div><span style=3D"font-size: 13.005px; line-height: 20.808px;"=
><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867r=
em; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; "\n"</span>=
</span></div><div><span style=3D"font-size: 13.005px; line-height=
: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-=
size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp;=
 "\n"</span></span></div><div><span style=3D"font-size: 13.005px;=
 line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" st=
yle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &=
nbsp; &nbsp; "\n"</span></span></div><div><span style=3D"font-siz=
e: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-=
wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nb=
sp; &nbsp; &nbsp; &nbsp; "\n" &nbsp;// console is 40 cols x 30 li=
nes</span></span></div><div><span style=3D"font-size: 13.005px; l=
ine-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" styl=
e=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nb=
sp; &nbsp; "\n"</span></span></div><div><span style=3D"font-size:=
 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wi=
z-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp=
; &nbsp; &nbsp; &nbsp; "\n"</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; &nbsp; &nbsp; "\n"</span></span></div><div><s=
pan style=3D"font-size: 13.005px; line-height: 20.808px;"><span d=
ata-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; colo=
r: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; "\n"</span></span><=
/div><div><span style=3D"font-size: 13.005px; line-height: 20.808=
px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.=
867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; "\n"</s=
pan></span></div><div><span style=3D"font-size: 13.005px; line-he=
ight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"f=
ont-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &n=
bsp; "\n"</span></span></div><div><span style=3D"font-size: 13.00=
5px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span=
" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbs=
p; &nbsp; &nbsp; "\n"</span></span></div><div><span style=3D"font=
-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"d=
ata-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);"=
>&nbsp; &nbsp; &nbsp; &nbsp; " &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=
 &nbsp; A N D R O I D ";</span></span></div><div><span style=3D"f=
ont-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; write(fd, msg, strlen(msg));</span=
></span></div><div><span style=3D"font-size: 13.005px; line-heigh=
t: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font=
-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp=
; close(fd);</span></span></div><div><span style=3D"font-size: 13=
.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-s=
pan" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &=
nbsp; }</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><br></span></div><div><span style=3D"f=
ont-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; return 0;</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">}</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><br></span></div><div><span style=3D"f=
ont-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">#ifdef BOOT_TRACE</span></span></div><div><span style=3D"font-=
size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"da=
ta-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">=
static bool boot_trace =3D false;</span></span></div><div><span s=
tyle=3D"font-size: 13.005px; line-height: 20.808px;"><span data-w=
iz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rg=
b(0, 0, 0);">#endif</span></span></div><div><span style=3D"font-s=
ize: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"dat=
a-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">s=
tatic void import_kernel_nv(const std::string&amp; key, const std=
::string&amp; value, bool for_emulator) {</span></span></div><div=
><span style=3D"font-size: 13.005px; line-height: 20.808px;"><spa=
n data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; c=
olor: rgb(0, 0, 0);">&nbsp; &nbsp; if (key.empty()) return;</span=
></span></div><div><span style=3D"font-size: 13.005px; line-heigh=
t: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font=
-size: 0.867rem; color: rgb(0, 0, 0);">#ifdef BOOT_TRACE</span></=
span></div><div><span style=3D"font-size: 13.005px; line-height:=20=
20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-si=
ze: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; /* enable systr=
ace if boot_trace cmdline available */</span></span></div><div><s=
pan style=3D"font-size: 13.005px; line-height: 20.808px;"><span d=
ata-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; colo=
r: rgb(0, 0, 0);">&nbsp; &nbsp; if (key =3D=3D "boot_trace" &amp;=
&amp; value =3D=3D "1")</span></span></div><div><span style=3D"fo=
nt-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; boot_trace =3D true;</span></span>=
</div><div><span style=3D"font-size: 13.005px; line-height: 20.80=
8px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0=
.867rem; color: rgb(0, 0, 0);">#endif</span></span></div><div><sp=
an style=3D"font-size: 13.005px; line-height: 20.808px;"><br></sp=
an></div><div><span style=3D"font-size: 13.005px; line-height: 20=
.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size=
: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (for_emulator)=
 {</span></span></div><div><span style=3D"font-size: 13.005px; li=
ne-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=
=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbs=
p; &nbsp; // In the emulator, export any kernel option with the "=
ro.kernel." prefix.</span></span></div><div><span style=3D"font-s=
ize: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"dat=
a-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&=
nbsp; &nbsp; &nbsp; &nbsp; property_set(android::base::StringPrin=
tf("ro.kernel.%s", key.c_str()).c_str(), value.c_str());</span></=
span></div><div><span style=3D"font-size: 13.005px; line-height:=20=
20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-si=
ze: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; r=
eturn;</span></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" s=
tyle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=20=
}</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><br></span></div><div><span style=3D"font-si=
ze: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data=
-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&n=
bsp; &nbsp; if (key =3D=3D "qemu") {</span></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; strlcpy(qemu, value.c=
_str(), sizeof(qemu));</span></span></div><div><span style=3D"fon=
t-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"=
data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);=
">&nbsp; &nbsp; } else if (android::base::StartsWith(key, "androi=
dboot.")) {</span></span></div><div><span style=3D"font-size: 13.=
005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-sp=
an" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &n=
bsp; &nbsp; &nbsp; property_set(android::base::StringPrintf("ro.b=
oot.%s", key.c_str() + 12).c_str(),</span></span></div><div><span=
 style=3D"font-size: 13.005px; line-height: 20.808px;"><span data=
-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=20=
rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &=
nbsp; &nbsp; &nbsp; &nbsp;value.c_str());</span></span></div><div=
><span style=3D"font-size: 13.005px; line-height: 20.808px;"><spa=
n data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; c=
olor: rgb(0, 0, 0);">&nbsp; &nbsp; }</span></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">}</span></span></div><div><span style=3D"font-siz=
e: 13.005px; line-height: 20.808px;"><br></span></div><div><span=20=
style=3D"font-size: 13.005px; line-height: 20.808px;"><span data-=
wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: r=
gb(0, 0, 0);">static void export_oem_lock_status() {</span></span=
></div><div><span style=3D"font-size: 13.005px; line-height: 20.8=
08px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=20=
0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (property_get("r=
o.oem_unlock_supported") !=3D "1") {</span></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; return;</span></span>=
</div><div><span style=3D"font-size: 13.005px; line-height: 20.80=
8px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0=
.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span></span></div=
><div><span style=3D"font-size: 13.005px; line-height: 20.808px;"=
><br></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"=
font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; std::str=
ing value =3D property_get("ro.boot.verifiedbootstate");</span></=
span></div><div><span style=3D"font-size: 13.005px; line-height:=20=
20.808px;"><br></span></div><div><span style=3D"font-size: 13.005=
px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=
 style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp=
; if (!value.empty()) {</span></span></div><div><span style=3D"fo=
nt-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; property_set("ro.boot.flash.locked=
", value =3D=3D "orange" ? "0" : "1");</span></span></div><div><s=
pan style=3D"font-size: 13.005px; line-height: 20.808px;"><span d=
ata-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; colo=
r: rgb(0, 0, 0);">&nbsp; &nbsp; }</span></span></div><div><span s=
tyle=3D"font-size: 13.005px; line-height: 20.808px;"><span data-w=
iz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rg=
b(0, 0, 0);">}</span></span></div><div><span style=3D"font-size:=20=
13.005px; line-height: 20.808px;"><br></span></div><div><span sty=
le=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz=
-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(=
0, 0, 0);">static void export_kernel_boot_props() {</span></span>=
</div><div><span style=3D"font-size: 13.005px; line-height: 20.80=
8px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0=
.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; struct {</span></spa=
n></div><div><span style=3D"font-size: 13.005px; line-height: 20.=
808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=
 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; cons=
t char *src_prop;</span></span></div><div><span style=3D"font-siz=
e: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-=
wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nb=
sp; &nbsp; &nbsp; &nbsp; const char *dst_prop;</span></span></div=
><div><span style=3D"font-size: 13.005px; line-height: 20.808px;"=
><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867r=
em; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; const char=20=
*default_value;</span></span></div><div><span style=3D"font-size:=
 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wi=
z-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp=
; &nbsp; } prop_map[] =3D {</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; &nbsp; &nbsp; { "ro.boot.serialno", &nbsp; "r=
o.serialno", &nbsp; "", },</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; &nbsp; &nbsp; { "ro.boot.mode", &nbsp; &nbsp;=
 &nbsp; "ro.bootmode", &nbsp; "unknown", },</span></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><s=
pan data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=
 color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; { "ro.boot.bas=
eband", &nbsp; "ro.baseband", &nbsp; "unknown", },</span></span><=
/div><div><span style=3D"font-size: 13.005px; line-height: 20.808=
px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.=
867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; { "ro.b=
oot.bootloader", "ro.bootloader", "unknown", },</span></span></di=
v><div><span style=3D"font-size: 13.005px; line-height: 20.808px;=
"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867=
rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; { "ro.boot=
.hardware", &nbsp; "ro.hardware", &nbsp; "unknown", },</span></sp=
an></div><div><span style=3D"font-size: 13.005px; line-height: 20=
.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size=
: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; { "=
ro.boot.revision", &nbsp; "ro.revision", &nbsp; "0", },</span></s=
pan></div><div><span style=3D"font-size: 13.005px; line-height: 2=
0.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-siz=
e: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; };</span></span>=
</div><div><span style=3D"font-size: 13.005px; line-height: 20.80=
8px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0=
.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; for (size_t i =3D 0;=
 i &lt; ARRAY_SIZE(prop_map); i++) {</span></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; std::string value =3D=
 property_get(prop_map[i].src_prop);</span></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; property_set(prop_map=
[i].dst_prop, (!value.empty()) ? value.c_str() : prop_map[i].defa=
ult_value);</span></span></div><div><span style=3D"font-size: 13.=
005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-sp=
an" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &n=
bsp; }</span></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" s=
tyle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">}</span></span=
></div><div><span style=3D"font-size: 13.005px; line-height: 20.8=
08px;"><br></span></div><div><span style=3D"font-size: 13.005px;=20=
line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" sty=
le=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">static void proc=
ess_kernel_dt() {</span></span></div><div><span style=3D"font-siz=
e: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-=
wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nb=
sp; &nbsp; static const char android_dir[] =3D "/proc/device-tree=
/firmware/android";</span></span></div><div><span style=3D"font-s=
ize: 13.005px; line-height: 20.808px;"><br></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">&nbsp; &nbsp; std::string file_name =3D android::=
base::StringPrintf("%s/compatible", android_dir);</span></span></=
div><div><span style=3D"font-size: 13.005px; line-height: 20.808p=
x;"><br></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; std::st=
ring dt_file;</span></span></div><div><span style=3D"font-size: 1=
3.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-=
span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;=20=
&nbsp; android::base::ReadFileToString(file_name, &amp;dt_file);<=
/span></span></div><div><span style=3D"font-size: 13.005px; line-=
height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (!dt=
_file.compare("android,firmware")) {</span></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; ERROR("firmware/andro=
id is not compatible with 'android,firmware'\n");</span></span></=
div><div><span style=3D"font-size: 13.005px; line-height: 20.808p=
x;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.8=
67rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; return;<=
/span></span></div><div><span style=3D"font-size: 13.005px; line-=
height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span=
></span></div><div><span style=3D"font-size: 13.005px; line-heigh=
t: 20.808px;"><br></span></div><div><span style=3D"font-size: 13.=
005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-sp=
an" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &n=
bsp; std::unique_ptr&lt;DIR, int(*)(DIR*)&gt;dir(opendir(android_=
dir), closedir);</span></span></div><div><span style=3D"font-size=
: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-w=
iz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbs=
p; &nbsp; if (!dir) return;</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><br></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><s=
pan data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=
 color: rgb(0, 0, 0);">&nbsp; &nbsp; struct dirent *dp;</span></s=
pan></div><div><span style=3D"font-size: 13.005px; line-height: 2=
0.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-siz=
e: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; while ((dp =3D r=
eaddir(dir.get())) !=3D NULL) {</span></span></div><div><span sty=
le=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz=
-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(=
0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; if (dp-&gt;d_type !=3D DT_=
REG || !strcmp(dp-&gt;d_name, "compatible") || !strcmp(dp-&gt;d_n=
ame, "name")) {</span></span></div><div><span style=3D"font-size:=
 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wi=
z-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp=
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;</span></span></div=
><div><span style=3D"font-size: 13.005px; line-height: 20.808px;"=
><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867r=
em; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; }</span></s=
pan></div><div><span style=3D"font-size: 13.005px; line-height: 2=
0.808px;"><br></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=20=
style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=
 &nbsp; &nbsp; file_name =3D android::base::StringPrintf("%s/%s",=
 android_dir, dp-&gt;d_name);</span></span></div><div><span style=
=3D"font-size: 13.005px; line-height: 20.808px;"><br></span></div=
><div><span style=3D"font-size: 13.005px; line-height: 20.808px;"=
><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867r=
em; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; android::ba=
se::ReadFileToString(file_name, &amp;dt_file);</span></span></div=
><div><span style=3D"font-size: 13.005px; line-height: 20.808px;"=
><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867r=
em; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; std::replac=
e(dt_file.begin(), dt_file.end(), ',', '.');</span></span></div><=
div><span style=3D"font-size: 13.005px; line-height: 20.808px;"><=
br></span></div><div><span style=3D"font-size: 13.005px; line-hei=
ght: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fo=
nt-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nb=
sp; std::string property_name =3D android::base::StringPrintf("ro=
.boot.%s", dp-&gt;d_name);</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; &nbsp; &nbsp; property_set(property_name.c_st=
r(), dt_file.c_str());</span></span></div><div><span style=3D"fon=
t-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"=
data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);=
">&nbsp; &nbsp; }</span></span></div><div><span style=3D"font-siz=
e: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-=
wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">}</=
span></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><br></span></div><div><span style=3D"font-size:=
 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wi=
z-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">stati=
c void process_kernel_cmdline() {</span></span></div><div><span s=
tyle=3D"font-size: 13.005px; line-height: 20.808px;"><span data-w=
iz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rg=
b(0, 0, 0);">&nbsp; &nbsp; // Don't expose the raw commandline to=
 unprivileged processes.</span></span></div><div><span style=3D"f=
ont-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; chmod("/proc/cmdline", 0440);</span></span></div=
><div><span style=3D"font-size: 13.005px; line-height: 20.808px;"=
><br></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"=
font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; // The f=
irst pass does the common stuff, and finds if we are in qemu.</sp=
an></span></div><div><span style=3D"font-size: 13.005px; line-hei=
ght: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fo=
nt-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; // The sec=
ond pass is only necessary for qemu to export all kernel params</=
span></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"=
font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; // as pr=
operties.</span></span></div><div><span style=3D"font-size: 13.00=
5px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span=
" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbs=
p; import_kernel_cmdline(false, import_kernel_nv);</span></span><=
/div><div><span style=3D"font-size: 13.005px; line-height: 20.808=
px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.=
867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (qemu[0]) import_k=
ernel_cmdline(true, import_kernel_nv);</span></span></div><div><s=
pan style=3D"font-size: 13.005px; line-height: 20.808px;"><span d=
ata-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; colo=
r: rgb(0, 0, 0);">}</span></span></div><div><span style=3D"font-s=
ize: 13.005px; line-height: 20.808px;"><br></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">static int queue_property_triggers_action(const s=
td::vector&lt;std::string&gt;&amp; args)</span></span></div><div>=
<span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=
 data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; co=
lor: rgb(0, 0, 0);">{</span></span></div><div><span style=3D"font=
-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"d=
ata-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);"=
>&nbsp; &nbsp; ActionManager::GetInstance().QueueAllPropertyTrigg=
ers();</span></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" s=
tyle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=20=
/* enable property triggers */</span></span></div><div><span styl=
e=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-=
span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0=
, 0, 0);">&nbsp; &nbsp; property_triggers_enabled =3D 1;</span></=
span></div><div><span style=3D"font-size: 13.005px; line-height:=20=
20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-si=
ze: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; return 0;</span=
></span></div><div><span style=3D"font-size: 13.005px; line-heigh=
t: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font=
-size: 0.867rem; color: rgb(0, 0, 0);">}</span></span></div><div>=
<span style=3D"font-size: 13.005px; line-height: 20.808px;"><br><=
/span></div><div><span style=3D"font-size: 13.005px; line-height:=
 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-s=
ize: 0.867rem; color: rgb(0, 0, 0);">static void selinux_init_all=
_handles(void)</span></span></div><div><span style=3D"font-size:=20=
13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz=
-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">{</spa=
n></span></div><div><span style=3D"font-size: 13.005px; line-heig=
ht: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fon=
t-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; sehandle =3D=
 selinux_android_file_context_handle();</span></span></div><div><=
span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=20=
data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; col=
or: rgb(0, 0, 0);">&nbsp; &nbsp; selinux_android_set_sehandle(seh=
andle);</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=20=
style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=
 sehandle_prop =3D selinux_android_prop_context_handle();</span><=
/span></div><div><span style=3D"font-size: 13.005px; line-height:=
 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-s=
ize: 0.867rem; color: rgb(0, 0, 0);">}</span></span></div><div><s=
pan style=3D"font-size: 13.005px; line-height: 20.808px;"><br></s=
pan></div><div><span style=3D"font-size: 13.005px; line-height: 2=
0.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-siz=
e: 0.867rem; color: rgb(0, 0, 0);">enum selinux_enforcing_status=20=
{ SELINUX_PERMISSIVE, SELINUX_ENFORCING };</span></span></div><di=
v><span style=3D"font-size: 13.005px; line-height: 20.808px;"><br=
></span></div><div><span style=3D"font-size: 13.005px; line-heigh=
t: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font=
-size: 0.867rem; color: rgb(0, 0, 0);">static selinux_enforcing_s=
tatus selinux_status_from_cmdline() {</span></span></div><div><sp=
an style=3D"font-size: 13.005px; line-height: 20.808px;"><span da=
ta-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color=
: rgb(0, 0, 0);">&nbsp; &nbsp; selinux_enforcing_status status =3D=
 SELINUX_ENFORCING;</span></span></div><div><span style=3D"font-s=
ize: 13.005px; line-height: 20.808px;"><br></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">&nbsp; &nbsp; import_kernel_cmdline(false, [&amp;=
](const std::string&amp; key, const std::string&amp; value, bool=20=
in_qemu) {</span></span></div><div><span style=3D"font-size: 13.0=
05px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-spa=
n" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nb=
sp; &nbsp; &nbsp; if (key =3D=3D "androidboot.selinux" &amp;&amp;=
 value =3D=3D "permissive") {</span></span></div><div><span style=
=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-s=
pan=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0,=
 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status =3D SEL=
INUX_PERMISSIVE;</span></span></div><div><span style=3D"font-size=
: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-w=
iz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbs=
p; &nbsp; &nbsp; &nbsp; }</span></span></div><div><span style=3D"=
font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; });</span></span></div><div><span style=3D"font-=
size: 13.005px; line-height: 20.808px;"><br></span></div><div><sp=
an style=3D"font-size: 13.005px; line-height: 20.808px;"><span da=
ta-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color=
: rgb(0, 0, 0);">&nbsp; &nbsp; return status;</span></span></div>=
<div><span style=3D"font-size: 13.005px; line-height: 20.808px;">=
<span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867re=
m; color: rgb(0, 0, 0);">}</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><br></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><s=
pan data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=
 color: rgb(0, 0, 0);">static bool selinux_is_enforcing(void)</sp=
an></span></div><div><span style=3D"font-size: 13.005px; line-hei=
ght: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fo=
nt-size: 0.867rem; color: rgb(0, 0, 0);">{</span></span></div><di=
v><span style=3D"font-size: 13.005px; line-height: 20.808px;"><sp=
an data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=20=
color: rgb(0, 0, 0);">&nbsp; &nbsp; if (ALLOW_PERMISSIVE_SELINUX)=
 {</span></span></div><div><span style=3D"font-size: 13.005px; li=
ne-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=
=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbs=
p; &nbsp; return selinux_status_from_cmdline() =3D=3D SELINUX_ENF=
ORCING;</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=20=
style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=
 }</span></span></div><div><span style=3D"font-size: 13.005px; li=
ne-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=
=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; retu=
rn true;</span></span></div><div><span style=3D"font-size: 13.005=
px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=
 style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">}</span></sp=
an></div><div><span style=3D"font-size: 13.005px; line-height: 20=
.808px;"><br></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" s=
tyle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">int selinux_re=
load_policy(void)</span></span></div><div><span style=3D"font-siz=
e: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-=
wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">{</=
span></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"=
font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; INFO("SE=
Linux: Attempting to reload policy files\n");</span></span></div>=
<div><span style=3D"font-size: 13.005px; line-height: 20.808px;">=
<br></span></div><div><span style=3D"font-size: 13.005px; line-he=
ight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"f=
ont-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (selin=
ux_android_reload_policy() =3D=3D -1) {</span></span></div><div><=
span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=20=
data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; col=
or: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; return -1;</span><=
/span></div><div><span style=3D"font-size: 13.005px; line-height:=
 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-s=
ize: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span></span=
></div><div><span style=3D"font-size: 13.005px; line-height: 20.8=
08px;"><br></span></div><div><span style=3D"font-size: 13.005px;=20=
line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" sty=
le=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if=
 (sehandle)</span></span></div><div><span style=3D"font-size: 13.=
005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-sp=
an" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &n=
bsp; &nbsp; &nbsp; selabel_close(sehandle);</span></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><b=
r></span></div><div><span style=3D"font-size: 13.005px; line-heig=
ht: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fon=
t-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (sehandl=
e_prop)</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=20=
style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=
 &nbsp; &nbsp; selabel_close(sehandle_prop);</span></span></div><=
div><span style=3D"font-size: 13.005px; line-height: 20.808px;"><=
br></span></div><div><span style=3D"font-size: 13.005px; line-hei=
ght: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fo=
nt-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; selinux_in=
it_all_handles();</span></span></div><div><span style=3D"font-siz=
e: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-=
wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nb=
sp; &nbsp; return 0;</span></span></div><div><span style=3D"font-=
size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"da=
ta-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">=
}</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><br></span></div><div><span style=3D"font-si=
ze: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data=
-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">st=
atic int audit_callback(void *data, security_class_t /*cls*/, cha=
r *buf, size_t len) {</span></span></div><div><span style=3D"font=
-size: 13.005px; line-height: 20.808px;"><br></span></div><div><s=
pan style=3D"font-size: 13.005px; line-height: 20.808px;"><span d=
ata-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; colo=
r: rgb(0, 0, 0);">&nbsp; &nbsp; property_audit_data *d =3D reinte=
rpret_cast&lt;property_audit_data*&gt;(data);</span></span></div>=
<div><span style=3D"font-size: 13.005px; line-height: 20.808px;">=
<br></span></div><div><span style=3D"font-size: 13.005px; line-he=
ight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"f=
ont-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (!d ||=
 !d-&gt;name || !d-&gt;cr) {</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; &nbsp; &nbsp; ERROR("audit_callback invoked w=
ith null data arguments!");</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; &nbsp; &nbsp; return 0;</span></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><s=
pan data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=
 color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span></span></div><div><s=
pan style=3D"font-size: 13.005px; line-height: 20.808px;"><br></s=
pan></div><div><span style=3D"font-size: 13.005px; line-height: 2=
0.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-siz=
e: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; snprintf(buf, le=
n, "property=3D%s pid=3D%d uid=3D%d gid=3D%d", d-&gt;name,</span>=
</span></div><div><span style=3D"font-size: 13.005px; line-height=
: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-=
size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp;=
 &nbsp; &nbsp; d-&gt;cr-&gt;pid, d-&gt;cr-&gt;uid, d-&gt;cr-&gt;g=
id);</span></span></div><div><span style=3D"font-size: 13.005px;=20=
line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" sty=
le=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; re=
turn 0;</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=20=
style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">}</span></spa=
n></div><div><span style=3D"font-size: 13.005px; line-height: 20.=
808px;"><br></span></div><div><span style=3D"font-size: 13.005px;=
 line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" st=
yle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">static void sel=
inux_initialize(bool in_kernel_domain) {</span></span></div><div>=
<span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=
 data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; co=
lor: rgb(0, 0, 0);">&nbsp; &nbsp; Timer t;</span></span></div><di=
v><span style=3D"font-size: 13.005px; line-height: 20.808px;"><br=
></span></div><div><span style=3D"font-size: 13.005px; line-heigh=
t: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font=
-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; selinux_call=
back cb;</span></span></div><div><span style=3D"font-size: 13.005=
px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=
 style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp=
; cb.func_log =3D selinux_klog_callback;</span></span></div><div>=
<span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=
 data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; co=
lor: rgb(0, 0, 0);">&nbsp; &nbsp; selinux_set_callback(SELINUX_CB=
_LOG, cb);</span></span></div><div><span style=3D"font-size: 13.0=
05px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-spa=
n" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nb=
sp; cb.func_audit =3D audit_callback;</span></span></div><div><sp=
an style=3D"font-size: 13.005px; line-height: 20.808px;"><span da=
ta-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color=
: rgb(0, 0, 0);">&nbsp; &nbsp; selinux_set_callback(SELINUX_CB_AU=
DIT, cb);</span></span></div><div><span style=3D"font-size: 13.00=
5px; line-height: 20.808px;"><br></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; if (in_kernel_domain) {</span></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><s=
pan data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=
 color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; INFO("Loading=20=
SELinux policy...\n");</span></span></div><div><span style=3D"fon=
t-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"=
data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);=
">&nbsp; &nbsp; &nbsp; &nbsp; if (selinux_android_load_policy() &=
lt; 0) {</span></span></div><div><span style=3D"font-size: 13.005=
px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=
 style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp=
; &nbsp; &nbsp; &nbsp; &nbsp; ERROR("failed to load policy: %s\n"=
, strerror(errno));</span></span></div><div><span style=3D"font-s=
ize: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"dat=
a-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&=
nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; security_failure();</spa=
n></span></div><div><span style=3D"font-size: 13.005px; line-heig=
ht: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fon=
t-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbs=
p; }</span></span></div><div><span style=3D"font-size: 13.005px;=20=
line-height: 20.808px;"><br></span></div><div><span style=3D"font=
-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"d=
ata-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);"=
>&nbsp; &nbsp; &nbsp; &nbsp; bool kernel_enforcing =3D (security_=
getenforce() =3D=3D 1);</span></span></div><div><span style=3D"fo=
nt-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; bool is_enforcing =3D selinux_is_e=
nforcing();</span></span></div><div><span style=3D"font-size: 13.=
005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-sp=
an" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &n=
bsp; &nbsp; &nbsp; if (kernel_enforcing !=3D is_enforcing) {</spa=
n></span></div><div><span style=3D"font-size: 13.005px; line-heig=
ht: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fon=
t-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbs=
p; &nbsp; &nbsp; if (security_setenforce(is_enforcing)) {</span><=
/span></div><div><span style=3D"font-size: 13.005px; line-height:=
 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-s=
ize: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp;=20=
&nbsp; &nbsp; &nbsp; &nbsp; ERROR("security_setenforce(%s) failed=
: %s\n",</span></span></div><div><span style=3D"font-size: 13.005=
px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=
 style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp=
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=20=
is_enforcing ? "true" : "false", strerror(errno));</span></span><=
/div><div><span style=3D"font-size: 13.005px; line-height: 20.808=
px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.=
867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=20=
&nbsp; &nbsp; &nbsp; security_failure();</span></span></div><div>=
<span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=
 data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; co=
lor: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</=
span></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"=
font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &=
nbsp; }</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><br></span></div><div><span style=3D"f=
ont-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; if (write_file("/sys/fs/selinux/ch=
eckreqprot", "0") =3D=3D -1) {</span></span></div><div><span styl=
e=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-=
span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0=
, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; security_fail=
ure();</span></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" s=
tyle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=20=
&nbsp; &nbsp; }</span></span></div><div><span style=3D"font-size:=
 13.005px; line-height: 20.808px;"><br></span></div><div><span st=
yle=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wi=
z-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb=
(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; NOTICE("(Initializing SEL=
inux %s took %.2fs.)\n",</span></span></div><div><span style=3D"f=
ont-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;is_enfo=
rcing ? "enforcing" : "non-enforcing", t.duration());</span></spa=
n></div><div><span style=3D"font-size: 13.005px; line-height: 20.=
808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=
 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; } else {</span></s=
pan></div><div><span style=3D"font-size: 13.005px; line-height: 2=
0.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-siz=
e: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; se=
linux_init_all_handles();</span></span></div><div><span style=3D"=
font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; }</span></span></div><div><span style=3D"font-si=
ze: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data=
-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">}<=
/span></span></div><div><span style=3D"font-size: 13.005px; line-=
height: 20.808px;"><br></span></div><div><span style=3D"font-size=
: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-w=
iz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">int=20=
main(int argc, char** argv) {</span></span></div><div><span style=
=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-s=
pan=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0,=
 0, 0);">&nbsp; &nbsp; if (!strcmp(basename(argv[0]), "ueventd"))=
 {</span></span></div><div><span style=3D"font-size: 13.005px; li=
ne-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=
=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbs=
p; &nbsp; return ueventd_main(argc, argv);</span></span></div><di=
v><span style=3D"font-size: 13.005px; line-height: 20.808px;"><sp=
an data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=20=
color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span></span></div><div><sp=
an style=3D"font-size: 13.005px; line-height: 20.808px;"><br></sp=
an></div><div><span style=3D"font-size: 13.005px; line-height: 20=
.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size=
: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (!strcmp(basen=
ame(argv[0]), "watchdogd")) {</span></span></div><div><span style=
=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-s=
pan=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0,=
 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; return watchdogd_main(argc,=20=
argv);</span></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" s=
tyle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=20=
}</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><br></span></div><div><span style=3D"font-si=
ze: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data=
-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&n=
bsp; &nbsp; // Clear the umask.</span></span></div><div><span sty=
le=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz=
-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(=
0, 0, 0);">&nbsp; &nbsp; umask(0);</span></span></div><div><span=20=
style=3D"font-size: 13.005px; line-height: 20.808px;"><br></span>=
</div><div><span style=3D"font-size: 13.005px; line-height: 20.80=
8px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0=
.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; add_environment("PAT=
H", _PATH_DEFPATH);</span></span></div><div><span style=3D"font-s=
ize: 13.005px; line-height: 20.808px;"><br></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><span dat=
a-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=
 rgb(0, 0, 0);">&nbsp; &nbsp; bool is_first_stage =3D (argc =3D=3D=
 1) || (strcmp(argv[1], "--second-stage") !=3D 0);</span></span><=
/div><div><span style=3D"font-size: 13.005px; line-height: 20.808=
px;"><br></span></div><div><span style=3D"font-size: 13.005px; li=
ne-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=
=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; // G=
et the basic filesystem setup we need put together in the initram=
disk</span></span></div><div><span style=3D"font-size: 13.005px;=20=
line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" sty=
le=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; //=
 on / and then we'll let the rc file figure out the rest.</span><=
/span></div><div><span style=3D"font-size: 13.005px; line-height:=
 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-s=
ize: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (is_first_s=
tage) {</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=20=
style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=
 &nbsp; &nbsp; mount("tmpfs", "/dev", "tmpfs", MS_NOSUID, "mode=3D=
0755");</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=20=
style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=
 &nbsp; &nbsp; mkdir("/dev/pts", 0755);</span></span></div><div><=
span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=20=
data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; col=
or: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; mkdir("/dev/socket=
", 0755);</span></span></div><div><span style=3D"font-size: 13.00=
5px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span=
" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbs=
p; &nbsp; &nbsp; mount("devpts", "/dev/pts", "devpts", 0, NULL);<=
/span></span></div><div><span style=3D"font-size: 13.005px; line-=
height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp;=20=
&nbsp; #define MAKE_STR(x) __STRING(x)</span></span></div><div><s=
pan style=3D"font-size: 13.005px; line-height: 20.808px;"><span d=
ata-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; colo=
r: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; mount("proc", "/pro=
c", "proc", 0, "hidepid=3D2,gid=3D" MAKE_STR(AID_READPROC));</spa=
n></span></div><div><span style=3D"font-size: 13.005px; line-heig=
ht: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fon=
t-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbs=
p; mount("sysfs", "/sys", "sysfs", 0, NULL);</span></span></div><=
div><span style=3D"font-size: 13.005px; line-height: 20.808px;"><=
span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem=
; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span></span></div><div><=
span style=3D"font-size: 13.005px; line-height: 20.808px;"><br></=
span></div><div><span style=3D"font-size: 13.005px; line-height:=20=
20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-si=
ze: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; // We must have=
 some place other than / to create the device nodes for</span></s=
pan></div><div><span style=3D"font-size: 13.005px; line-height: 2=
0.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-siz=
e: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; // kmsg and null=
, otherwise we won't be able to remount / read-only</span></span>=
</div><div><span style=3D"font-size: 13.005px; line-height: 20.80=
8px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0=
.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; // later on. Now tha=
t tmpfs is mounted on /dev, we can actually talk</span></span></d=
iv><div><span style=3D"font-size: 13.005px; line-height: 20.808px=
;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.86=
7rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; // to the outside world=
.</span></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; open_de=
vnull_stdio();</span></span></div><div><span style=3D"font-size:=20=
13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz=
-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;=
 &nbsp; klog_init();</span></span></div><div><span style=3D"font-=
size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"da=
ta-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">=
&nbsp; &nbsp; klog_set_level(KLOG_NOTICE_LEVEL);</span></span></d=
iv><div><span style=3D"font-size: 13.005px; line-height: 20.808px=
;"><br></span></div><div><span style=3D"font-size: 13.005px; line=
-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; NOTICE(=
"init %s started!\n", is_first_stage ? "first stage" : "second st=
age");</span></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><br></span></div><div><span style=3D"fo=
nt-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; if (!is_first_stage) {</span></span></div><div><=
span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=20=
data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; col=
or: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; // Indicate that b=
ooting is in progress to background fw loaders, etc.</span></span=
></div><div><span style=3D"font-size: 13.005px; line-height: 20.8=
08px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=20=
0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; close=
(open("/dev/.booting", O_WRONLY | O_CREAT | O_CLOEXEC, 0000));</s=
pan></span></div><div><span style=3D"font-size: 13.005px; line-he=
ight: 20.808px;"><br></span></div><div><span style=3D"font-size:=20=
13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz=
-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;=
 &nbsp; &nbsp; &nbsp; property_init();</span></span></div><div><s=
pan style=3D"font-size: 13.005px; line-height: 20.808px;"><br></s=
pan></div><div><span style=3D"font-size: 13.005px; line-height: 2=
0.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-siz=
e: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; //=
 If arguments are passed both on the command line and in DT,</spa=
n></span></div><div><span style=3D"font-size: 13.005px; line-heig=
ht: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fon=
t-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbs=
p; // properties set in DT always have priority over the command-=
line ones.</span></span></div><div><span style=3D"font-size: 13.0=
05px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-spa=
n" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nb=
sp; &nbsp; &nbsp; process_kernel_dt();</span></span></div><div><s=
pan style=3D"font-size: 13.005px; line-height: 20.808px;"><span d=
ata-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; colo=
r: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; process_kernel_cmdl=
ine();</span></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><br></span></div><div><span style=3D"fo=
nt-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; // Propagate the kernel variables=20=
to internal variables</span></span></div><div><span style=3D"font=
-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"d=
ata-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);"=
>&nbsp; &nbsp; &nbsp; &nbsp; // used by init as well as the curre=
nt required properties.</span></span></div><div><span style=3D"fo=
nt-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; export_kernel_boot_props();</span>=
</span></div><div><span style=3D"font-size: 13.005px; line-height=
: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-=
size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span></spa=
n></div><div><span style=3D"font-size: 13.005px; line-height: 20.=
808px;"><br></span></div><div><span style=3D"font-size: 13.005px;=
 line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" st=
yle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; /=
/ Set up SELinux, including loading the SELinux policy if we're i=
n the kernel domain.</span></span></div><div><span style=3D"font-=
size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"da=
ta-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">=
&nbsp; &nbsp; selinux_initialize(is_first_stage);</span></span></=
div><div><span style=3D"font-size: 13.005px; line-height: 20.808p=
x;"><br></span></div><div><span style=3D"font-size: 13.005px; lin=
e-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; // If w=
e're in the kernel domain, re-exec init to transition to the init=
 domain now</span></span></div><div><span style=3D"font-size: 13.=
005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-sp=
an" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &n=
bsp; // that the SELinux policy has been loaded.</span></span></d=
iv><div><span style=3D"font-size: 13.005px; line-height: 20.808px=
;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.86=
7rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (is_first_stage) {</=
span></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"=
font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &=
nbsp; if (restorecon("/init") =3D=3D -1) {</span></span></div><di=
v><span style=3D"font-size: 13.005px; line-height: 20.808px;"><sp=
an data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=20=
color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E=
RROR("restorecon failed: %s\n", strerror(errno));</span></span></=
div><div><span style=3D"font-size: 13.005px; line-height: 20.808p=
x;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.8=
67rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &=
nbsp; security_failure();</span></span></div><div><span style=3D"=
font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></span></div><div><span st=
yle=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wi=
z-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb=
(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; char* path =3D argv[0];</=
span></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"=
font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &=
nbsp; char* args[] =3D { path, const_cast&lt;char*&gt;("--second-=
stage"), nullptr };</span></span></div><div><span style=3D"font-s=
ize: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"dat=
a-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&=
nbsp; &nbsp; &nbsp; &nbsp; if (execv(path, args) =3D=3D -1) {</sp=
an></span></div><div><span style=3D"font-size: 13.005px; line-hei=
ght: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fo=
nt-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nb=
sp; &nbsp; &nbsp; ERROR("execv(\"%s\") failed: %s\n", path, strer=
ror(errno));</span></span></div><div><span style=3D"font-size: 13=
.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-s=
pan" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &=
nbsp; &nbsp; &nbsp; &nbsp; &nbsp; security_failure();</span></spa=
n></div><div><span style=3D"font-size: 13.005px; line-height: 20.=
808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=
 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; }</s=
pan></span></div><div><span style=3D"font-size: 13.005px; line-he=
ight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"f=
ont-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span><=
/span></div><div><span style=3D"font-size: 13.005px; line-height:=
 20.808px;"><br></span></div><div><span style=3D"font-size: 13.00=
5px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span=
" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbs=
p; // These directories were necessarily created before initial p=
olicy load</span></span></div><div><span style=3D"font-size: 13.0=
05px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-spa=
n" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nb=
sp; // and therefore need their security context restored to the=20=
proper value.</span></span></div><div><span style=3D"font-size: 1=
3.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-=
span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;=20=
&nbsp; // This must happen before /dev is populated by ueventd.</=
span></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"=
font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; NOTICE("=
Running restorecon...\n");</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; restorecon("/dev");</span></span></div><div><=
span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=20=
data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; col=
or: rgb(0, 0, 0);">&nbsp; &nbsp; restorecon("/dev/socket");</span=
></span></div><div><span style=3D"font-size: 13.005px; line-heigh=
t: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font=
-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; restorecon("=
/dev/__properties__");</span></span></div><div><span style=3D"fon=
t-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"=
data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);=
">&nbsp; &nbsp; restorecon("/property_contexts");</span></span></=
div><div><span style=3D"font-size: 13.005px; line-height: 20.808p=
x;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.8=
67rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; restorecon_recursive("=
/sys");</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><br></span></div><div><span style=3D"f=
ont-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; epoll_fd =3D epoll_create1(EPOLL_CLOEXEC);</span=
></span></div><div><span style=3D"font-size: 13.005px; line-heigh=
t: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font=
-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (epoll_fd=
 =3D=3D -1) {</span></span></div><div><span style=3D"font-size: 1=
3.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-=
span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;=20=
&nbsp; &nbsp; &nbsp; ERROR("epoll_create1 failed: %s\n", strerror=
(errno));</span></span></div><div><span style=3D"font-size: 13.00=
5px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span=
" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbs=
p; &nbsp; &nbsp; exit(1);</span></span></div><div><span style=3D"=
font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; }</span></span></div><div><span style=3D"font-si=
ze: 13.005px; line-height: 20.808px;"><br></span></div><div><span=
 style=3D"font-size: 13.005px; line-height: 20.808px;"><span data=
-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color:=20=
rgb(0, 0, 0);">&nbsp; &nbsp; signal_handler_init();</span></span>=
</div><div><span style=3D"font-size: 13.005px; line-height: 20.80=
8px;"><br></span></div><div><span style=3D"font-size: 13.005px; l=
ine-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" styl=
e=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; pro=
perty_load_boot_defaults();</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; export_oem_lock_status();</span></span></div>=
<div><span style=3D"font-size: 13.005px; line-height: 20.808px;">=
<span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867re=
m; color: rgb(0, 0, 0);">&nbsp; &nbsp; start_property_service();<=
/span></span></div><div><span style=3D"font-size: 13.005px; line-=
height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">#ifdef BOOT_TRACE</sp=
an></span></div><div><span style=3D"font-size: 13.005px; line-hei=
ght: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fo=
nt-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; if (boot_t=
race) {</span></span></div><div><span style=3D"font-size: 13.005p=
x; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=20=
style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp;=
 &nbsp; &nbsp; ERROR("enable boot systrace...");</span></span></d=
iv><div><span style=3D"font-size: 13.005px; line-height: 20.808px=
;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.86=
7rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; property_=
set("debug.atrace.tags.enableflags", "0x3ffffe");</span></span></=
div><div><span style=3D"font-size: 13.005px; line-height: 20.808p=
x;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.8=
67rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span></span></div><=
div><span style=3D"font-size: 13.005px; line-height: 20.808px;"><=
span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem=
; color: rgb(0, 0, 0);">#endif</span></span></div><div><span styl=
e=3D"font-size: 13.005px; line-height: 20.808px;"><br></span></di=
v><div><span style=3D"font-size: 13.005px; line-height: 20.808px;=
"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867=
rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; const BuiltinFunctionMap=
 function_map;</span></span></div><div><span style=3D"font-size:=20=
13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz=
-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;=
 &nbsp; Action::set_function_map(&amp;function_map);</span></span=
></div><div><span style=3D"font-size: 13.005px; line-height: 20.8=
08px;"><br></span></div><div><span style=3D"font-size: 13.005px;=20=
line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" sty=
le=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; Pa=
rser&amp; parser =3D Parser::GetInstance();</span></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><s=
pan data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=
 color: rgb(0, 0, 0);">&nbsp; &nbsp; parser.AddSectionParser("ser=
vice",std::make_unique&lt;ServiceParser&gt;());</span></span></di=
v><div><span style=3D"font-size: 13.005px; line-height: 20.808px;=
"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867=
rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; parser.AddSectionParser(=
"on", std::make_unique&lt;ActionParser&gt;());</span></span></div=
><div><span style=3D"font-size: 13.005px; line-height: 20.808px;"=
><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867r=
em; color: rgb(0, 0, 0);">&nbsp; &nbsp; parser.AddSectionParser("=
import", std::make_unique&lt;ImportParser&gt;());</span></span></=
div><div><span style=3D"font-size: 13.005px; line-height: 20.808p=
x;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.8=
67rem; color: rgb(0, 0, 0); background-color: rgb(255, 0, 0);">&n=
bsp; &nbsp; parser.ParseConfig("/init.rc"); &nbsp;<b><span data-w=
iz-span=3D"data-wiz-span" style=3D"color: rgb(0, 0, 255);">--&gt;=
=D6=D8=B5=E3=C4=D1=B5=E3</span></b></span></span></div><div><span=
 style=3D"font-size: 13.005px; line-height: 20.808px;"><br></span=
></div><div><span style=3D"font-size: 13.005px; line-height: 20.8=
08px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=20=
0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; ActionManager&amp;=20=
am =3D ActionManager::GetInstance();</span></span></div><div><spa=
n style=3D"font-size: 13.005px; line-height: 20.808px;"><br></spa=
n></div><div><span style=3D"font-size: 13.005px; line-height: 20.=
808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=
 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; am.QueueEventTrigg=
er("early-init");</span></span></div><div><span style=3D"font-siz=
e: 13.005px; line-height: 20.808px;"><br></span></div><div><span=20=
style=3D"font-size: 13.005px; line-height: 20.808px;"><span data-=
wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: r=
gb(0, 0, 0);">&nbsp; &nbsp; // Queue an action that waits for col=
dboot done so we know ueventd has set up all of /dev...</span></s=
pan></div><div><span style=3D"font-size: 13.005px; line-height: 2=
0.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-siz=
e: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; am.QueueBuiltinA=
ction(wait_for_coldboot_done_action, "wait_for_coldboot_done");</=
span></span></div><div><span style=3D"font-size: 13.005px; line-h=
eight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"=
font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; // ... s=
o that we can start queuing up actions that require stuff from /d=
ev.</span></span></div><div><span style=3D"font-size: 13.005px; l=
ine-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" styl=
e=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; am.=
QueueBuiltinAction(mix_hwrng_into_linux_rng_action, "mix_hwrng_in=
to_linux_rng");</span></span></div><div><span style=3D"font-size:=
 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wi=
z-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp=
; &nbsp; am.QueueBuiltinAction(set_mmap_rnd_bits_action, "set_mma=
p_rnd_bits");</span></span></div><div><span style=3D"font-size: 1=
3.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-=
span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;=20=
&nbsp; am.QueueBuiltinAction(keychord_init_action, "keychord_init=
");</span></span></div><div><span style=3D"font-size: 13.005px; l=
ine-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" styl=
e=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; am.=
QueueBuiltinAction(console_init_action, "console_init");</span></=
span></div><div><span style=3D"font-size: 13.005px; line-height:=20=
20.808px;"><br></span></div><div><span style=3D"font-size: 13.005=
px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span"=
 style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp=
; // Trigger all the boot actions to get us started.</span></span=
></div><div><span style=3D"font-size: 13.005px; line-height: 20.8=
08px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=20=
0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; am.QueueEventTrigge=
r("init");</span></span></div><div><span style=3D"font-size: 13.0=
05px; line-height: 20.808px;"><br></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; // Repeat mix_hwrng_into_linux_rng in case /d=
ev/hw_random or /dev/random</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; // wasn't ready immediately after wait_for_co=
ldboot_done</span></span></div><div><span style=3D"font-size: 13.=
005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-sp=
an" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &n=
bsp; am.QueueBuiltinAction(mix_hwrng_into_linux_rng_action, "mix_=
hwrng_into_linux_rng");</span></span></div><div><span style=3D"fo=
nt-size: 13.005px; line-height: 20.808px;"><br></span></div><div>=
<span style=3D"font-size: 13.005px; line-height: 20.808px;"><span=
 data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; co=
lor: rgb(0, 0, 0);">&nbsp; &nbsp; // Don't mount filesystems or s=
tart core system services in charger mode.</span></span></div><di=
v><span style=3D"font-size: 13.005px; line-height: 20.808px;"><sp=
an data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem;=20=
color: rgb(0, 0, 0);">&nbsp; &nbsp; std::string bootmode =3D prop=
erty_get("ro.bootmode");</span></span></div><div><span style=3D"f=
ont-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; if (bootmode =3D=3D "charger") {</span></span></=
div><div><span style=3D"font-size: 13.005px; line-height: 20.808p=
x;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.8=
67rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; am.Queue=
EventTrigger("charger");</span></span></div><div><span style=3D"f=
ont-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; } else {</span></span></div><div><span style=3D"=
font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; am.QueueEventTrigger("late-init");=
</span></span></div><div><span style=3D"font-size: 13.005px; line=
-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span=
></span></div><div><span style=3D"font-size: 13.005px; line-heigh=
t: 20.808px;"><br></span></div><div><span style=3D"font-size: 13.=
005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-sp=
an" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &n=
bsp; // Run all property triggers based on current state of the p=
roperties.</span></span></div><div><span style=3D"font-size: 13.0=
05px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-spa=
n" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nb=
sp; am.QueueBuiltinAction(queue_property_triggers_action, "queue_=
property_triggers");</span></span></div><div><span style=3D"font-=
size: 13.005px; line-height: 20.808px;"><br></span></div><div><sp=
an style=3D"font-size: 13.005px; line-height: 20.808px;"><span da=
ta-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color=
: rgb(0, 0, 0);">&nbsp; &nbsp; while (true) {</span></span></div>=
<div><span style=3D"font-size: 13.005px; line-height: 20.808px;">=
<span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867re=
m; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; if (!waiting=
_for_exec) {</span></span></div><div><span style=3D"font-size: 13=
.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-s=
pan" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &=
nbsp; &nbsp; &nbsp; &nbsp; &nbsp; am.ExecuteOneCommand();</span><=
/span></div><div><span style=3D"font-size: 13.005px; line-height:=
 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-s=
ize: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp;=20=
&nbsp; &nbsp; restart_processes();</span></span></div><div><span=20=
style=3D"font-size: 13.005px; line-height: 20.808px;"><span data-=
wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: r=
gb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; }</span></span></div><d=
iv><span style=3D"font-size: 13.005px; line-height: 20.808px;"><b=
r></span></div><div><span style=3D"font-size: 13.005px; line-heig=
ht: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"fon=
t-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbs=
p; int timeout =3D -1;</span></span></div><div><span style=3D"fon=
t-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"=
data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);=
">&nbsp; &nbsp; &nbsp; &nbsp; if (process_needs_restart) {</span>=
</span></div><div><span style=3D"font-size: 13.005px; line-height=
: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-=
size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp;=
 &nbsp; &nbsp; timeout =3D (process_needs_restart - gettime()) *=20=
1000;</span></span></div><div><span style=3D"font-size: 13.005px;=
 line-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" st=
yle=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &=
nbsp; &nbsp; &nbsp; &nbsp; if (timeout &lt; 0)</span></span></div=
><div><span style=3D"font-size: 13.005px; line-height: 20.808px;"=
><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867r=
em; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbs=
p; &nbsp; &nbsp; timeout =3D 0;</span></span></div><div><span sty=
le=3D"font-size: 13.005px; line-height: 20.808px;"><span data-wiz=
-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(=
0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; }</span></span></div><div>=
<span style=3D"font-size: 13.005px; line-height: 20.808px;"><br><=
/span></div><div><span style=3D"font-size: 13.005px; line-height:=
 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-s=
ize: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp;=20=
if (am.HasMoreCommands()) {</span></span></div><div><span style=3D=
"font-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=
=3D"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0,=
 0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timeout =3D 0;</s=
pan></span></div><div><span style=3D"font-size: 13.005px; line-he=
ight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"f=
ont-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &n=
bsp; }</span></span></div><div><span style=3D"font-size: 13.005px=
; line-height: 20.808px;"><br></span></div><div><span style=3D"fo=
nt-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D=
"data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0)=
;">&nbsp; &nbsp; &nbsp; &nbsp; bootchart_sample(&amp;timeout);</s=
pan></span></div><div><span style=3D"font-size: 13.005px; line-he=
ight: 20.808px;"><br></span></div><div><span style=3D"font-size:=20=
13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wiz=
-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp;=
 &nbsp; &nbsp; &nbsp; epoll_event ev;</span></span></div><div><sp=
an style=3D"font-size: 13.005px; line-height: 20.808px;"><span da=
ta-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; color=
: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; int nr =3D TEMP_FAIL=
URE_RETRY(epoll_wait(epoll_fd, &amp;ev, 1, timeout));</span></spa=
n></div><div><span style=3D"font-size: 13.005px; line-height: 20.=
808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size:=
 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; if (=
nr =3D=3D -1) {</span></span></div><div><span style=3D"font-size:=
 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"data-wi=
z-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp=
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ERROR("epoll_wait failed: %s=
\n", strerror(errno));</span></span></div><div><span style=3D"fon=
t-size: 13.005px; line-height: 20.808px;"><span data-wiz-span=3D"=
data-wiz-span" style=3D"font-size: 0.867rem; color: rgb(0, 0, 0);=
">&nbsp; &nbsp; &nbsp; &nbsp; } else if (nr =3D=3D 1) {</span></s=
pan></div><div><span style=3D"font-size: 13.005px; line-height: 2=
0.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-siz=
e: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; &n=
bsp; &nbsp; ((void (*)()) ev.data.ptr)();</span></span></div><div=
><span style=3D"font-size: 13.005px; line-height: 20.808px;"><spa=
n data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.867rem; c=
olor: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; }</span></span><=
/div><div><span style=3D"font-size: 13.005px; line-height: 20.808=
px;"><span data-wiz-span=3D"data-wiz-span" style=3D"font-size: 0.=
867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; }</span></span></div>=
<div><span style=3D"font-size: 13.005px; line-height: 20.808px;">=
<br></span></div><div><span style=3D"font-size: 13.005px; line-he=
ight: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D"f=
ont-size: 0.867rem; color: rgb(0, 0, 0);">&nbsp; &nbsp; return 0;=
</span></span></div><div><span style=3D"font-size: 13.005px; line=
-height: 20.808px;"><span data-wiz-span=3D"data-wiz-span" style=3D=
"font-size: 0.867rem; color: rgb(0, 0, 0);">}</span></span></div>=
<div style=3D"font-size: 13.005px; line-height: 20.808px;"><br></=
div></span></font></div></body></html>

------=_Next_Part_0138523093.966--

------=_Next_Part_0415569279.840--

